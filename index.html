<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Distribution Engine</title>
    <script src="https://api.bitrix24.com/api/v1/"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ===== ROOT VARIABLES ‚Äî Promed Dark Theme ===== */
        :root {
            --bg-base: #0b0d12;
            --bg-raised: #12151c;
            --bg-surface: #181c26;
            --bg-hover: #1e232f;
            --bg-input: #0f1118;

            --border-subtle: rgba(255,255,255,0.05);
            --border-default: rgba(255,255,255,0.08);
            --border-strong: rgba(255,255,255,0.12);

            --text-primary: #eef1f6;
            --text-secondary: #8d95a5;
            --text-muted: #5c6478;
            --text-faint: #3f4759;

            --accent: #dc2626;
            --accent-soft: rgba(220,38,38,0.10);
            --accent-text: #fca5a5;

            --green: #34d399;
            --green-soft: rgba(52,211,153,0.08);
            --green-text: #6ee7b7;

            --amber: #fbbf24;
            --amber-soft: rgba(251,191,36,0.08);
            --amber-text: #fcd34d;

            --red: #ef4444;
            --red-soft: rgba(239,68,68,0.08);

            --blue: #60a5fa;
            --blue-soft: rgba(96,165,250,0.08);

            --rose: #fb7185;
            --rose-soft: rgba(251,113,133,0.10);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* ===== HEADER ===== */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 28px;
            background: var(--bg-raised);
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 28px;
            background: var(--bg-raised);
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo,
        .app-title .icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .header-title,
        .app-title h1 {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .header-tag,
        .app-title .version {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            background: var(--bg-surface);
            padding: 2px 8px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 6px rgba(52,211,153,0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .header-meta {
            color: var(--text-faint);
            font-size: 11px;
        }

        .header-meta strong {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .status-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ===== TABS ===== */
        .tabs,
        .tab-bar {
            display: flex;
            gap: 2px;
            padding: 0 28px;
            background: var(--bg-raised);
            border-bottom: 1px solid var(--border-subtle);
        }

        .tab {
            padding: 11px 18px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .tab:hover { color: var(--text-secondary); }

        .tab.active {
            color: var(--accent-text);
            border-bottom-color: var(--accent);
        }

        .tab-icon { font-size: 14px; }

        .tab-count,
        .tab .badge {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-faint);
            background: var(--bg-surface);
            padding: 0 6px;
            border-radius: 8px;
            min-width: 20px;
            text-align: center;
        }

        .tab.active .tab-count,
        .tab.active .badge {
            color: var(--accent-text);
            background: var(--accent-soft);
        }

        /* ===== CONTENT ===== */
        .content { padding: 24px 28px; position: relative; z-index: 1; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ===== SECTION LABEL ===== */
        .section-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-label h2 {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        .section-label .subtitle {
            font-size: 12px;
            color: var(--text-faint);
            margin-left: 10px;
            font-weight: 400;
        }

        /* ===== TOOLBAR ===== */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== STAT CARDS ===== */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 16px 18px;
            transition: border-color 0.2s;
        }

        .stat-card:hover { border-color: var(--border-default); }

        .stat-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-faint);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .stat-value.green { color: var(--green); }
        .stat-value.amber { color: var(--amber); }
        .stat-value.red { color: var(--red); }
        .stat-value.blue { color: var(--blue); }

        .stat-sub {
            font-size: 11px;
            color: var(--text-faint);
            margin-top: 2px;
        }

        /* ===== ACTION BAR ===== */
        .action-bar {
            background: var(--bg-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .action-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-info .icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--accent-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .action-title {
            font-size: 14px;
            font-weight: 600;
        }

        .action-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .action-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            border: 1px solid var(--border-default);
            background: var(--bg-surface);
            color: var(--text-secondary);
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--accent);
            border-color: transparent;
            color: white;
        }

        .btn-primary:hover {
            background: #b91c1c;
        }

        .btn-go {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            border-color: transparent;
            color: white;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            box-shadow: 0 2px 16px rgba(220,38,38,0.25);
        }

        .btn-go:hover {
            box-shadow: 0 4px 24px rgba(220,38,38,0.35);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--green), #10b981);
            border-color: transparent;
            color: white;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(52,211,153,0.15);
        }

        .btn-success:hover {
            box-shadow: 0 4px 20px rgba(52,211,153,0.25);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--red-soft);
            border-color: rgba(248,113,113,0.3);
            color: var(--red);
        }

        .btn-danger:hover {
            background: var(--red);
            border-color: var(--red);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 6px;
        }

        .btn-icon {
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-ghost {
            background: transparent;
            border-color: transparent;
            color: var(--text-muted);
        }

        .btn-ghost:hover {
            background: var(--bg-surface);
            color: var(--text-secondary);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-run {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: #fff;
            border: none;
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-run:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            transform: translateY(-1px);
        }
        .btn-run:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ===== CHECKBOX ‚Äî dry run ===== */
        .check-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .check-label input[type="checkbox"] {
            accent-color: #dc2626;
        }

        /* ===== TOGGLE SWITCH ===== */
        .toggle {
            position: relative;
            width: 36px;
            height: 20px;
            cursor: pointer;
        }

        .toggle input { opacity: 0; width: 0; height: 0; }

        .toggle-track {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .toggle-thumb {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.2s;
        }

        .toggle input:checked ~ .toggle-track {
            background: var(--accent-soft);
            border-color: var(--accent);
        }

        .toggle input:checked ~ .toggle-thumb {
            left: 19px;
            background: var(--accent);
        }

        /* Old toggle (compatibility) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
            cursor: pointer;
            vertical-align: middle;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            inset: 0;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 10px;
            transition: 0.2s;
        }
        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            left: 3px;
            bottom: 3px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: 0.2s;
        }
        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent-soft);
            border-color: var(--accent);
        }
        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(16px);
            background: var(--accent);
        }

        /* ===== TABLE ===== */
        .table-wrap,
        .table-container {
            background: var(--bg-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 10px 16px;
            text-align: left;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-faint);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
        }

        td {
            padding: 12px 16px;
            font-size: 13px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-subtle);
            vertical-align: middle;
        }

        tr:last-child td { border-bottom: none; }

        tr:hover td { background: rgba(255,255,255,0.015); }

        .rule-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
        }

        .rule-conditions {
            font-size: 11px;
            color: var(--text-faint);
        }

        /* ===== TAGS ===== */
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            line-height: 1.5;
        }

        .tag-lang {
            background: rgba(220,38,38,0.10);
            color: #fca5a5;
        }

        .tag-phone {
            background: var(--amber-soft);
            color: var(--amber-text);
        }

        .tag-service {
            background: var(--green-soft);
            color: var(--green-text);
        }

        .tag-more {
            background: var(--bg-surface);
            color: var(--text-muted);
            cursor: pointer;
        }

        .tag-more:hover {
            color: var(--text-secondary);
            background: var(--bg-hover);
        }

        /* Old tag colors (compatibility) */
        .tag-green {
            background: var(--green-soft);
            color: var(--green-text);
        }

        .tag-yellow {
            background: var(--amber-soft);
            color: var(--amber-text);
        }

        .tag-red {
            background: var(--red-soft);
            color: var(--red);
        }

        .status-active {
            color: var(--green);
            font-weight: 500;
        }

        .status-inactive {
            color: var(--red);
            font-weight: 500;
        }

        /* ===== PERSONNEL PILLS ===== */
        .personnel-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }

        .p-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--blue-soft);
            color: var(--blue);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .p-pill-count {
            background: var(--bg-surface);
            color: var(--text-muted);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .p-pill-count:hover {
            color: var(--text-secondary);
        }

        /* ===== KOTA BADGE ===== */
        .kota-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-surface);
            color: var(--text-secondary);
        }

        /* ===== RULE ACTIONS ===== */
        .rule-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 28px;
            width: 560px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.6);
        }

        .modal h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-faint);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input:not([type="checkbox"]),
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-group input:not([type="checkbox"]):focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
            background: var(--bg-surface);
        }

        .form-group .hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group { flex: 1; }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        /* ===== DISTRIBUTION PANEL (legacy layout) ===== */
        .dist-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .dist-card {
            background: var(--bg-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 18px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .dist-card:hover {
            border-color: var(--border-default);
        }

        .dist-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            border-radius: 10px 10px 0 0;
        }

        .dist-card.card-indigo::before { background: linear-gradient(90deg, #dc2626, #ef4444); }
        .dist-card.card-cyan::before { background: linear-gradient(90deg, var(--blue), #dc2626); }
        .dist-card.card-emerald::before { background: linear-gradient(90deg, var(--green), #10b981); }
        .dist-card.card-rose::before { background: linear-gradient(90deg, var(--red), #f87171); }

        .dist-card h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-secondary);
        }

        .dist-card h3 .card-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        .card-indigo .card-icon { background: rgba(220,38,38,0.10); }
        .card-cyan .card-icon { background: var(--blue-soft); }
        .card-emerald .card-icon { background: var(--green-soft); }
        .card-rose .card-icon { background: var(--red-soft); }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 14px;
            transition: border-color 0.2s;
        }

        .stat-item:hover {
            border-color: var(--border-default);
        }

        .stat-item .label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-faint);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .stat-item .value {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            line-height: 1.1;
            font-variant-numeric: tabular-nums;
        }

        .stat-item .value .sub {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-faint);
        }

        .stat-item .value.text-success { color: var(--green); }
        .stat-item .value.text-warning { color: var(--amber); }
        .stat-item .value.text-danger { color: var(--red); }

        .start-section {
            text-align: center;
            padding: 36px 20px;
            background: var(--bg-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .start-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #dc2626, #ef4444, #dc2626, transparent);
        }

        .start-section h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }

        .start-section p {
            color: var(--text-muted);
            font-size: 13px;
            margin-bottom: 24px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .start-options {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        /* ===== PROGRESS ===== */
        .progress-section,
        .progress-container {
            background: var(--bg-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 20px 24px;
            margin-top: 16px;
        }

        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-container.active { display: block; }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-title .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .progress-bar-track,
        .progress-bar-bg {
            height: 6px;
            background: var(--bg-input);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-bg {
            height: 6px;
            margin: 12px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc2626, #ef4444);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-faint);
            font-family: 'JetBrains Mono', monospace;
        }

        .progress-log {
            margin-top: 12px;
            background: var(--bg-base);
            border-radius: 8px;
            padding: 12px 14px;
            max-height: 180px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            line-height: 1.7;
            color: var(--text-faint);
        }

        .progress-log .log-line {
            padding: 2px 0;
        }

        /* New reference class names */
        .log-line.ok { color: var(--green-text); }
        .log-line.info { color: var(--accent-text); }
        .log-line.err { color: var(--red); }
        /* Old class names (compatibility) */
        .log-line.success { color: var(--green-text); }
        .log-line.error { color: var(--red); }

        /* ===== PERSONNEL TAB ===== */
        .personnel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 10px;
        }

        .person-card {
            background: var(--bg-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: border-color 0.15s;
        }

        .person-card:hover { border-color: var(--border-default); }

        .person-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(220,38,38,0.10);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: #fca5a5;
            flex-shrink: 0;
        }

        .person-info { flex: 1; min-width: 0; }

        .person-name {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .person-meta {
            font-size: 11px;
            color: var(--text-faint);
            display: flex;
            gap: 8px;
        }

        .person-bar-track {
            width: 100%;
            height: 3px;
            background: var(--bg-input);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .person-bar-fill {
            height: 100%;
            border-radius: 2px;
            background: var(--green);
        }

        .person-bar-fill.mid { background: var(--amber); }
        .person-bar-fill.low { background: var(--red); }

        /* ===== LEAD PIVOT TABLE ===== */
        .pivot-section {
            margin-top: 24px;
        }
        .pivot-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .pivot-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .pivot-wrap {
            background: var(--bg-raised);
            border: 2px solid var(--border-strong);
            border-radius: 10px;
            overflow-x: auto;
        }
        .pivot-wrap table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        .pivot-wrap th,
        .pivot-wrap td {
            border: 1px solid var(--border-default);
        }
        .pivot-wrap th {
            padding: 10px 14px;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-strong);
            white-space: nowrap;
        }
        .pivot-wrap th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--bg-surface);
            z-index: 1;
            min-width: 160px;
        }
        .pivot-wrap td {
            padding: 10px 14px;
            font-size: 13px;
            text-align: center;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-subtle);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        .pivot-wrap td:first-child {
            text-align: left;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            left: 0;
            background: var(--bg-raised);
            z-index: 1;
        }
        .pivot-wrap tr:hover td {
            background: rgba(255,255,255,0.015);
        }
        .pivot-wrap tr:hover td:first-child {
            background: var(--bg-hover);
        }
        .pivot-wrap tr:last-child td { border-bottom: none; }
        .pivot-wrap tr.pivot-total td {
            background: var(--bg-surface);
            font-weight: 700;
            color: var(--text-primary);
            border-top: 2px solid var(--border-strong);
        }
        .pivot-wrap tr.pivot-total td:first-child {
            background: var(--bg-surface);
        }
        .pivot-cell-zero { color: var(--text-faint) !important; opacity: 0.4; }
        .pivot-cell-high { color: var(--amber-text) !important; }
        .pivot-cell-critical { color: var(--red) !important; font-weight: 700 !important; }
        .pivot-loading {
            text-align: center;
            padding: 32px;
            color: var(--text-muted);
            font-size: 13px;
        }
        .pivot-loading .spinner-inline {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--border-default);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .person-stats {
            text-align: right;
            flex-shrink: 0;
        }

        .person-count {
            font-size: 18px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .person-quota {
            font-size: 10px;
            color: var(--text-faint);
        }

        /* ===== LOG TABLE ===== */
        .log-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: center;
        }

        .log-filters input {
            padding: 8px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            width: 250px;
        }

        .log-filters input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon { font-size: 40px; margin-bottom: 16px; opacity: 0.6; }
        .empty-state h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .empty-state p { font-size: 12px; margin-bottom: 20px; }

        /* ===== PICKER (Multi-select checkbox list) ===== */
        .picker-container {
            max-height: 130px;
            overflow-y: auto;
            border: 1px solid var(--border-default);
            border-radius: 8px;
            background: var(--bg-input);
            padding: 4px;
        }

        .picker-item {
            display: flex !important;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px !important;
            color: var(--text-secondary) !important;
            text-transform: none !important;
            letter-spacing: normal !important;
            margin-bottom: 0 !important;
            transition: background 0.15s;
            user-select: none;
        }

        .picker-item:hover {
            background: var(--bg-hover);
        }

        .picker-item.checked {
            background: var(--accent-soft);
            color: var(--text-primary) !important;
        }

        .picker-item input[type="checkbox"] {
            accent-color: #dc2626;
            width: 15px;
            height: 15px;
            cursor: pointer;
        }

        .picker-search {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            margin-bottom: 6px;
            transition: border-color 0.2s;
        }

        .picker-search:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .picker-select-all {
            display: inline-flex !important;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            font-size: 12px !important;
            color: var(--text-muted) !important;
            text-transform: none !important;
            letter-spacing: normal !important;
            cursor: pointer;
            user-select: none;
            margin-bottom: 6px !important;
        }

        .picker-select-all input[type="checkbox"] {
            accent-color: #dc2626;
            cursor: pointer;
        }

        /* ===== WATERMARK ===== */
        .watermark {
            position: fixed;
            bottom: 12px;
            right: 16px;
            font-size: 10px;
            color: var(--text-faint);
            opacity: 0.4;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }

        /* ===== COUNTRY ANALYSIS PANEL ===== */
        .country-panel {
            background: var(--bg-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .country-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }

        .country-panel-header:hover {
            background: var(--bg-hover);
        }

        .country-panel-header .panel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .country-panel-header .panel-toggle {
            font-size: 12px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .country-panel.open .panel-toggle {
            transform: rotate(180deg);
        }

        .country-panel-body {
            display: none;
            padding: 0 20px 20px;
        }

        .country-panel.open .country-panel-body {
            display: block;
        }

        .country-scan-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .country-scan-bar .scan-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        .country-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .country-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px 14px;
            transition: border-color 0.15s;
        }

        .country-card:hover {
            border-color: var(--border-default);
        }

        .country-card-top {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .country-card-flag {
            font-size: 20px;
            line-height: 1;
        }

        .country-card-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .country-card-prefix {
            font-size: 10px;
            color: var(--text-faint);
        }

        .country-card-count {
            font-size: 22px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .country-bar-track {
            height: 4px;
            background: var(--bg-input);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .country-bar-fill {
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, #dc2626, #ef4444);
            transition: width 0.3s;
        }

        .country-card-pct {
            font-size: 10px;
            color: var(--text-faint);
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .dist-panel { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .personnel-grid { grid-template-columns: 1fr; }
            .country-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row { flex-direction: column; }
            .content { padding: 16px; }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header class="header">
    <div class="header-left">
        <div class="logo">‚ö°</div>
        <span class="header-title">Lead Distribution Engine</span>
        <span class="header-tag">v2.1</span>
    </div>
    <div class="header-right">
        <span class="status-dot" id="connectionDot"></span>
        <span class="header-meta" id="connectionStatus">Baƒülanƒ±yor...</span>
        <span class="header-meta">|</span>
        <span class="header-meta" id="headerEnumInfo"></span>
    </div>
</header>

<!-- TABS -->
<nav class="tabs">
    <div class="tab active" data-tab="distribution"><span class="tab-icon">‚ö°</span> Daƒüƒ±tƒ±m</div>
    <div class="tab" data-tab="rules"><span class="tab-icon">üìã</span> Kurallar <span class="tab-count" id="rulesBadge">0</span></div>
    <div class="tab" data-tab="personnel"><span class="tab-icon">üë•</span> Personel <span class="tab-count" id="personnelBadge">0</span></div>
    <div class="tab" data-tab="logs"><span class="tab-icon">üìä</span> Loglar <span class="tab-count" id="logsBadge">0</span></div>
</nav>

<!-- CONTENT -->
<div class="content">

    <!-- ========== TAB: DISTRIBUTION ========== -->
    <div class="tab-content active" id="tab-distribution">
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">Havuzdaki Lead</div>
                <div class="stat-value" id="statPoolLeads">-</div>
                <div class="stat-sub">Promed Database</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Personel (Kurala Dahil)</div>
                <div class="stat-value" id="statActivePersonnel">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Toplam ƒ∞htiya√ß</div>
                <div class="stat-value amber" id="statTotalNeed">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Aktif Kural</div>
                <div class="stat-value" id="statActiveRules">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Son Daƒüƒ±tƒ±m</div>
                <div class="stat-value green" id="statLastDistributed" style="font-size:18px;">-</div>
                <div class="stat-sub" id="statLastDate">-</div>
            </div>
        </div>

        <!-- COUNTRY ANALYSIS PANEL -->
        <div class="country-panel" id="countryPanel">
            <div class="country-panel-header" onclick="toggleCountryPanel()">
                <div class="panel-title">üåç Havuz √úlke Analizi</div>
                <span class="panel-toggle">‚ñº</span>
            </div>
            <div class="country-panel-body">
                <div class="country-scan-bar">
                    <button class="btn btn-sm btn-primary" id="countryScanBtn" onclick="startCountryScan()">üìä Analiz Ba≈ülat</button>
                    <button class="btn btn-sm" id="countryRescanBtn" onclick="startCountryScan()" style="display:none;">üîÑ Yeniden Tara</button>
                    <span class="scan-status" id="countryScanStatus"></span>
                </div>
                <div class="country-grid" id="countryGrid"></div>
                <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border-subtle);">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <span style="font-size:13px;font-weight:600;">üîç Prefix Te≈ühis</span>
                        <input type="text" id="diagPrefixInput" placeholder="+359" value="+359" style="width:80px;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border-default);border-radius:6px;color:var(--text-primary);font-size:12px;font-family:inherit;">
                        <button class="btn btn-sm btn-primary" id="diagBtn" onclick="runPrefixDiag()">Tara</button>
                        <span style="font-size:11px;color:var(--text-muted);" id="diagStatus"></span>
                    </div>
                    <div id="diagResults" style="font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.8;color:var(--text-secondary);max-height:200px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <div class="action-info">
                <div class="icon-circle">üöÄ</div>
                <div>
                    <div class="action-title">Lead Daƒüƒ±tƒ±mƒ±</div>
                    <div class="action-desc">Havuzdaki leadleri kurallara g√∂re personellere daƒüƒ±t</div>
                </div>
            </div>
            <div class="action-controls">
                <button class="btn btn-sm" id="refreshCountsBtn" onclick="refreshPersonnelCounts()" title="Personel lead sayƒ±larƒ±nƒ± Bitrix24'ten g√ºncelle">üîÑ Canlƒ± Veri G√ºncelle</button>
                <label class="check-label">
                    <input type="checkbox" id="dryRunCheck"> Dry Run (test)
                </label>
                <button class="btn btn-go" id="startDistBtn" onclick="startDistribution()">‚ö° Daƒüƒ±tƒ±mƒ± Ba≈ülat</button>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-header">
                <div class="progress-title">
                    <span class="live-dot"></span>
                    <span id="progressTitle">Daƒüƒ±tƒ±m ba≈ülatƒ±lƒ±yor...</span>
                </div>
                <button class="btn btn-sm" id="stopBtn" onclick="stopDistribution()" style="color:var(--red);border-color:rgba(248,113,113,0.3);">‚èπ Durdur</button>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
            <div class="progress-meta">
                <span id="progressPercent">0%</span>
                <span id="progressDetail">Hazƒ±rlanƒ±yor...</span>
            </div>
            <div class="progress-log" id="progressLog"></div>
        </div>
    </div>

    <!-- ========== TAB: RULES ========== -->
    <div class="tab-content" id="tab-rules">
        <div class="section-label">
            <div>
                <h2 style="display:inline;">Daƒüƒ±tƒ±m Kurallarƒ±</h2>
                <span class="subtitle">Spesifik kurallar √∂nce uygulanƒ±r (√ßok ko≈üul > az ko≈üul)</span>
            </div>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-sm" onclick="exportRules()">üì• Dƒ±≈üa Aktar</button>
                <button class="btn btn-sm" onclick="document.getElementById('importRulesInput').click()">üì§ ƒ∞√ße Aktar</button>
                <input type="file" id="importRulesInput" accept=".json" style="display:none" onchange="importRules(event)">
                <button class="btn btn-sm btn-primary" onclick="openRuleModal()">+ Yeni Kural</button>
            </div>
        </div>

        <div class="table-wrap" id="rulesTableContainer">
            <table>
                <thead>
                    <tr>
                        <th style="width:30px">#</th>
                        <th>Kural</th>
                        <th>Dil</th>
                        <th>Prefix</th>
                        <th>Servis</th>
                        <th>Personeller</th>
                        <th style="width:60px">Kota</th>
                        <th style="width:50px">Aktif</th>
                        <th style="width:110px">ƒ∞≈ülem</th>
                    </tr>
                </thead>
                <tbody id="rulesTableBody">
                </tbody>
            </table>
        </div>

        <div class="empty-state" id="rulesEmpty">
            <div class="icon">üìã</div>
            <h3>Hen√ºz kural tanƒ±mlanmamƒ±≈ü</h3>
            <p>Leadlerin nasƒ±l daƒüƒ±tƒ±lacaƒüƒ±nƒ± belirleyen kurallarƒ± ekleyin.</p>
            <button class="btn btn-primary" onclick="openRuleModal()">+ ƒ∞lk Kuralƒ± Ekle</button>
        </div>
    </div>

    <!-- ========== TAB: PERSONNEL ========== -->
    <div class="tab-content" id="tab-personnel">
        <div class="section-label">
            <div>
                <h2 style="display:inline;">Personel</h2>
                <span class="subtitle" id="personnelSubtitle"></span>
            </div>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-sm" id="personnelRefreshBtn" onclick="refreshPersonnelCounts()">üîÑ Canlƒ± Veri G√ºncelle</button>
                <button class="btn btn-sm" onclick="syncPersonnel()">üë• Senkronize Et</button>
                <button class="btn btn-sm btn-primary" onclick="openPersonnelModal()">+ Personel Ekle</button>
            </div>
        </div>

        <div class="personnel-grid" id="personnelTableContainer">
        </div>

        <div class="empty-state" id="personnelEmpty">
            <div class="icon">üë•</div>
            <h3>Hen√ºz personel eklenmemi≈ü</h3>
            <p>Lead daƒüƒ±tƒ±lacak personelleri ekleyin veya Bitrix24'ten senkronize edin.</p>
            <button class="btn btn-primary" onclick="openPersonnelModal()">+ Personel Ekle</button>
        </div>

        <!-- LEAD PIVOT TABLE -->
        <div class="pivot-section" id="pivotSection" style="display:none;">
            <div class="pivot-header">
                <h3>üìä Lead A≈üama Daƒüƒ±lƒ±mƒ±</h3>
                <button class="btn btn-sm" onclick="loadLeadPivot()">üîÑ G√ºncelle</button>
            </div>
            <div id="pivotContainer">
                <div class="pivot-loading">Veriler y√ºklenmedi. Yukarƒ±daki <strong>üîÑ G√ºncelle</strong> butonuna tƒ±klayƒ±n.</div>
            </div>
        </div>
    </div>

    <!-- ========== TAB: LOGS ========== -->
    <div class="tab-content" id="tab-logs">
        <div class="section-label">
            <div>
                <h2 style="display:inline;">Daƒüƒ±tƒ±m Loglarƒ±</h2>
            </div>
            <div>
                <button class="btn btn-sm" onclick="clearLogs()" style="color:var(--red);border-color:rgba(248,113,113,0.2);">üóë Loglarƒ± Temizle</button>
            </div>
        </div>

        <div class="table-wrap" id="logsTableContainer">
            <table>
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Mod</th>
                        <th>Toplam Lead</th>
                        <th>Daƒüƒ±tƒ±lan</th>
                        <th>E≈üle≈ümeyen</th>
                        <th>Hata</th>
                        <th>S√ºre</th>
                        <th style="width:80px;">Detay</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                </tbody>
            </table>
        </div>

        <div class="empty-state" id="logsEmpty">
            <div class="icon">üìä</div>
            <h3>Hen√ºz daƒüƒ±tƒ±m yapƒ±lmamƒ±≈ü</h3>
            <p>ƒ∞lk daƒüƒ±tƒ±mƒ± yaptƒ±ƒüƒ±nƒ±zda loglar burada g√∂r√ºnecek.</p>
        </div>
    </div>
</div>

<!-- ========== RULE MODAL ========== -->
<div class="modal-overlay" id="ruleModal">
    <div class="modal">
        <h3 id="ruleModalTitle">Yeni Kural Ekle</h3>
        <input type="hidden" id="ruleEditIndex" value="-1">

        <div class="form-group">
            <label>Kural Adƒ±</label>
            <input type="text" id="ruleName" placeholder="√ñrn: DACH √úlkeleri Almanca">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Dil (bo≈ü = farketmez)</label>
                <div class="picker-container" id="ruleLanguagePicker"></div>
                <div class="hint">Birden fazla se√ßebilirsiniz</div>
            </div>
            <div class="form-group">
                <label>Telefon Prefix / √úlke (bo≈ü = farketmez)</label>
                <div style="display:flex;gap:6px;margin-bottom:6px;">
                    <input type="text" id="customPrefixInput" placeholder="√ñr: +4,+90" style="flex:1;padding:8px 12px;background:var(--bg-input);border:1px solid var(--border-default);border-radius:8px;color:var(--text-primary);font-size:12px;font-family:inherit;">
                    <button type="button" class="btn btn-sm btn-primary" onclick="addCustomPrefixes()">Ekle</button>
                </div>
                <input type="text" class="picker-search" id="countryPickerSearch" placeholder="√úlke ara..." oninput="filterCountryPicker()">
                <div class="picker-container" id="ruleCountryPicker" style="max-height:150px;"></div>
                <div class="hint">Geni≈ü prefix yazƒ±n (+4 t√ºm +4x √ºlkeleri kapsar) veya listeden se√ßin</div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Servis (bo≈ü = farketmez)</label>
                <div class="picker-container" id="ruleServicePicker"></div>
                <div class="hint">Birden fazla se√ßebilirsiniz</div>
            </div>
            <div class="form-group">
                <label>Kota</label>
                <input type="number" id="ruleQuota" value="200" min="1">
                <div class="hint">Bu kuraldaki personellerin hedef lead sayƒ±sƒ±</div>
            </div>
        </div>

        <div class="form-group">
            <label>Personeller</label>
            <label class="picker-select-all"><input type="checkbox" id="rulePersonnelAll" onchange="togglePersonnelAll(this)"> T√ºm Aktif Personel (ALL)</label>
            <input type="text" class="picker-search" id="personnelSearch" placeholder="ƒ∞sim ara..." oninput="filterPersonnelPicker()">
            <div class="picker-container" id="rulePersonnelPicker" style="max-height:150px;"></div>
        </div>

        <div class="form-group">
            <label>Aktif</label>
            <select id="ruleActive">
                <option value="true">Evet</option>
                <option value="false">Hayƒ±r</option>
            </select>
        </div>

        <div class="modal-actions">
            <button class="btn" onclick="closeRuleModal()">ƒ∞ptal</button>
            <button class="btn btn-primary" onclick="saveRule()">Kaydet</button>
        </div>
    </div>
</div>

<!-- ========== PERSONNEL MODAL ========== -->
<div class="modal-overlay" id="personnelModal">
    <div class="modal">
        <h3 id="personnelModalTitle">Personel Ekle</h3>
        <input type="hidden" id="personnelEditIndex" value="-1">

        <div class="form-row">
            <div class="form-group">
                <label>Bitrix24 Kullanƒ±cƒ± ID</label>
                <input type="number" id="personnelBitrixId" placeholder="√ñrn: 145">
            </div>
            <div class="form-group">
                <label>Ad Soyad</label>
                <input type="text" id="personnelName" placeholder="√ñrn: Ali Yƒ±lmaz">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Varsayƒ±lan Kota</label>
                <input type="number" id="personnelQuota" value="200" min="1">
            </div>
            <div class="form-group">
                <label>Aktif</label>
                <select id="personnelActive">
                    <option value="true">Evet</option>
                    <option value="false">Hayƒ±r</option>
                </select>
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn" onclick="closePersonnelModal()">ƒ∞ptal</button>
            <button class="btn btn-primary" onclick="savePersonnel()">Kaydet</button>
        </div>
    </div>
</div>

<!-- ========== LOG DETAIL MODAL ========== -->
<div class="modal-overlay" id="logDetailModal">
    <div class="modal" style="width:700px;">
        <h3>Daƒüƒ±tƒ±m Detayƒ±</h3>
        <div id="logDetailContent"></div>
        <div class="modal-actions">
            <button class="btn" onclick="closeLogDetailModal()">Kapat</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// FIELD MAPPING ‚Äî Bitrix24 Custom Field Adlarƒ±
// ============================================================
const FIELD_MAP = {
    language: 'UF_CRM_2DAD13E3',       // Language (enumeration/dropdown)
    phoneFilter: 'UF_CRM_67505AD0F07CF', // Phone Filter (string)
    service: 'UF_CRM_B30DE58E',          // Lead Requirement / Service (enumeration/dropdown)
    leadCreatedTime: 'UF_CRM_1732716702'  // Lead Created Time (datetime ‚Äî custom)
};

// ============================================================
// COUNTRY MAP ‚Äî Telefon prefix ‚Üí √úlke e≈üle≈ütirme
// ============================================================
const COUNTRY_MAP = {
    '+93': { name: 'Afganistan', flag: '\u{1F1E6}\u{1F1EB}', code: 'AF' },
    '+355': { name: 'Arnavutluk', flag: '\u{1F1E6}\u{1F1F1}', code: 'AL' },
    '+213': { name: 'Cezayir', flag: '\u{1F1E9}\u{1F1FF}', code: 'DZ' },
    '+376': { name: 'Andorra', flag: '\u{1F1E6}\u{1F1E9}', code: 'AD' },
    '+244': { name: 'Angola', flag: '\u{1F1E6}\u{1F1F4}', code: 'AO' },
    '+54': { name: 'Arjantin', flag: '\u{1F1E6}\u{1F1F7}', code: 'AR' },
    '+374': { name: 'Ermenistan', flag: '\u{1F1E6}\u{1F1F2}', code: 'AM' },
    '+61': { name: 'Avustralya', flag: '\u{1F1E6}\u{1F1FA}', code: 'AU' },
    '+43': { name: 'Avusturya', flag: '\u{1F1E6}\u{1F1F9}', code: 'AT' },
    '+994': { name: 'Azerbaycan', flag: '\u{1F1E6}\u{1F1FF}', code: 'AZ' },
    '+973': { name: 'Bahreyn', flag: '\u{1F1E7}\u{1F1ED}', code: 'BH' },
    '+880': { name: 'Banglade≈ü', flag: '\u{1F1E7}\u{1F1E9}', code: 'BD' },
    '+375': { name: 'Belarus', flag: '\u{1F1E7}\u{1F1FE}', code: 'BY' },
    '+32': { name: 'Bel√ßika', flag: '\u{1F1E7}\u{1F1EA}', code: 'BE' },
    '+387': { name: 'Bosna Hersek', flag: '\u{1F1E7}\u{1F1E6}', code: 'BA' },
    '+55': { name: 'Brezilya', flag: '\u{1F1E7}\u{1F1F7}', code: 'BR' },
    '+359': { name: 'Bulgaristan', flag: '\u{1F1E7}\u{1F1EC}', code: 'BG' },
    '+1': { name: 'ABD / Kanada', flag: '\u{1F1FA}\u{1F1F8}', code: 'US' },
    '+56': { name: '≈ûili', flag: '\u{1F1E8}\u{1F1F1}', code: 'CL' },
    '+86': { name: '√áin', flag: '\u{1F1E8}\u{1F1F3}', code: 'CN' },
    '+57': { name: 'Kolombiya', flag: '\u{1F1E8}\u{1F1F4}', code: 'CO' },
    '+385': { name: 'Hƒ±rvatistan', flag: '\u{1F1ED}\u{1F1F7}', code: 'HR' },
    '+357': { name: 'Kƒ±brƒ±s', flag: '\u{1F1E8}\u{1F1FE}', code: 'CY' },
    '+420': { name: '√áekya', flag: '\u{1F1E8}\u{1F1FF}', code: 'CZ' },
    '+45': { name: 'Danimarka', flag: '\u{1F1E9}\u{1F1F0}', code: 'DK' },
    '+20': { name: 'Mƒ±sƒ±r', flag: '\u{1F1EA}\u{1F1EC}', code: 'EG' },
    '+372': { name: 'Estonya', flag: '\u{1F1EA}\u{1F1EA}', code: 'EE' },
    '+358': { name: 'Finlandiya', flag: '\u{1F1EB}\u{1F1EE}', code: 'FI' },
    '+33': { name: 'Fransa', flag: '\u{1F1EB}\u{1F1F7}', code: 'FR' },
    '+995': { name: 'G√ºrcistan', flag: '\u{1F1EC}\u{1F1EA}', code: 'GE' },
    '+49': { name: 'Almanya', flag: '\u{1F1E9}\u{1F1EA}', code: 'DE' },
    '+30': { name: 'Yunanistan', flag: '\u{1F1EC}\u{1F1F7}', code: 'GR' },
    '+36': { name: 'Macaristan', flag: '\u{1F1ED}\u{1F1FA}', code: 'HU' },
    '+91': { name: 'Hindistan', flag: '\u{1F1EE}\u{1F1F3}', code: 'IN' },
    '+62': { name: 'Endonezya', flag: '\u{1F1EE}\u{1F1E9}', code: 'ID' },
    '+98': { name: 'ƒ∞ran', flag: '\u{1F1EE}\u{1F1F7}', code: 'IR' },
    '+964': { name: 'Irak', flag: '\u{1F1EE}\u{1F1F6}', code: 'IQ' },
    '+353': { name: 'ƒ∞rlanda', flag: '\u{1F1EE}\u{1F1EA}', code: 'IE' },
    '+972': { name: 'ƒ∞srail', flag: '\u{1F1EE}\u{1F1F1}', code: 'IL' },
    '+39': { name: 'ƒ∞talya', flag: '\u{1F1EE}\u{1F1F9}', code: 'IT' },
    '+81': { name: 'Japonya', flag: '\u{1F1EF}\u{1F1F5}', code: 'JP' },
    '+962': { name: '√úrd√ºn', flag: '\u{1F1EF}\u{1F1F4}', code: 'JO' },
    '+77': { name: 'Kazakistan', flag: '\u{1F1F0}\u{1F1FF}', code: 'KZ' },
    '+254': { name: 'Kenya', flag: '\u{1F1F0}\u{1F1EA}', code: 'KE' },
    '+383': { name: 'Kosova', flag: '\u{1F1FD}\u{1F1F0}', code: 'XK' },
    '+965': { name: 'Kuveyt', flag: '\u{1F1F0}\u{1F1FC}', code: 'KW' },
    '+996': { name: 'Kƒ±rgƒ±zistan', flag: '\u{1F1F0}\u{1F1EC}', code: 'KG' },
    '+371': { name: 'Letonya', flag: '\u{1F1F1}\u{1F1FB}', code: 'LV' },
    '+961': { name: 'L√ºbnan', flag: '\u{1F1F1}\u{1F1E7}', code: 'LB' },
    '+218': { name: 'Libya', flag: '\u{1F1F1}\u{1F1FE}', code: 'LY' },
    '+370': { name: 'Litvanya', flag: '\u{1F1F1}\u{1F1F9}', code: 'LT' },
    '+352': { name: 'L√ºksemburg', flag: '\u{1F1F1}\u{1F1FA}', code: 'LU' },
    '+60': { name: 'Malezya', flag: '\u{1F1F2}\u{1F1FE}', code: 'MY' },
    '+356': { name: 'Malta', flag: '\u{1F1F2}\u{1F1F9}', code: 'MT' },
    '+52': { name: 'Meksika', flag: '\u{1F1F2}\u{1F1FD}', code: 'MX' },
    '+373': { name: 'Moldova', flag: '\u{1F1F2}\u{1F1E9}', code: 'MD' },
    '+382': { name: 'Karadaƒü', flag: '\u{1F1F2}\u{1F1EA}', code: 'ME' },
    '+212': { name: 'Fas', flag: '\u{1F1F2}\u{1F1E6}', code: 'MA' },
    '+31': { name: 'Hollanda', flag: '\u{1F1F3}\u{1F1F1}', code: 'NL' },
    '+64': { name: 'Yeni Zelanda', flag: '\u{1F1F3}\u{1F1FF}', code: 'NZ' },
    '+234': { name: 'Nijerya', flag: '\u{1F1F3}\u{1F1EC}', code: 'NG' },
    '+389': { name: 'Kuzey Makedonya', flag: '\u{1F1F2}\u{1F1F0}', code: 'MK' },
    '+47': { name: 'Norve√ß', flag: '\u{1F1F3}\u{1F1F4}', code: 'NO' },
    '+968': { name: 'Umman', flag: '\u{1F1F4}\u{1F1F2}', code: 'OM' },
    '+92': { name: 'Pakistan', flag: '\u{1F1F5}\u{1F1F0}', code: 'PK' },
    '+48': { name: 'Polonya', flag: '\u{1F1F5}\u{1F1F1}', code: 'PL' },
    '+351': { name: 'Portekiz', flag: '\u{1F1F5}\u{1F1F9}', code: 'PT' },
    '+974': { name: 'Katar', flag: '\u{1F1F6}\u{1F1E6}', code: 'QA' },
    '+40': { name: 'Romanya', flag: '\u{1F1F7}\u{1F1F4}', code: 'RO' },
    '+7': { name: 'Rusya', flag: '\u{1F1F7}\u{1F1FA}', code: 'RU' },
    '+966': { name: 'Suudi Arabistan', flag: '\u{1F1F8}\u{1F1E6}', code: 'SA' },
    '+381': { name: 'Sƒ±rbistan', flag: '\u{1F1F7}\u{1F1F8}', code: 'RS' },
    '+65': { name: 'Singapur', flag: '\u{1F1F8}\u{1F1EC}', code: 'SG' },
    '+421': { name: 'Slovakya', flag: '\u{1F1F8}\u{1F1F0}', code: 'SK' },
    '+386': { name: 'Slovenya', flag: '\u{1F1F8}\u{1F1EE}', code: 'SI' },
    '+27': { name: 'G√ºney Afrika', flag: '\u{1F1FF}\u{1F1E6}', code: 'ZA' },
    '+82': { name: 'G√ºney Kore', flag: '\u{1F1F0}\u{1F1F7}', code: 'KR' },
    '+34': { name: 'ƒ∞spanya', flag: '\u{1F1EA}\u{1F1F8}', code: 'ES' },
    '+46': { name: 'ƒ∞sve√ß', flag: '\u{1F1F8}\u{1F1EA}', code: 'SE' },
    '+41': { name: 'ƒ∞svi√ßre', flag: '\u{1F1E8}\u{1F1ED}', code: 'CH' },
    '+992': { name: 'Tacikistan', flag: '\u{1F1F9}\u{1F1EF}', code: 'TJ' },
    '+66': { name: 'Tayland', flag: '\u{1F1F9}\u{1F1ED}', code: 'TH' },
    '+216': { name: 'Tunus', flag: '\u{1F1F9}\u{1F1F3}', code: 'TN' },
    '+90': { name: 'T√ºrkiye', flag: '\u{1F1F9}\u{1F1F7}', code: 'TR' },
    '+993': { name: 'T√ºrkmenistan', flag: '\u{1F1F9}\u{1F1F2}', code: 'TM' },
    '+380': { name: 'Ukrayna', flag: '\u{1F1FA}\u{1F1E6}', code: 'UA' },
    '+971': { name: 'BAE', flag: '\u{1F1E6}\u{1F1EA}', code: 'AE' },
    '+44': { name: 'ƒ∞ngiltere', flag: '\u{1F1EC}\u{1F1E7}', code: 'GB' },
    '+998': { name: '√ñzbekistan', flag: '\u{1F1FA}\u{1F1FF}', code: 'UZ' },
    '+58': { name: 'Venezuela', flag: '\u{1F1FB}\u{1F1EA}', code: 'VE' },
    '+84': { name: 'Vietnam', flag: '\u{1F1FB}\u{1F1F3}', code: 'VN' },
    '+967': { name: 'Yemen', flag: '\u{1F1FE}\u{1F1EA}', code: 'YE' },
};

// Uzundan kƒ±saya sƒ±ralƒ± prefix listesi ‚Äî uzun prefix √∂nce e≈üle≈üsin (+77 Kazakistan > +7 Rusya)
const _COUNTRY_PREFIXES_SORTED = Object.keys(COUNTRY_MAP).sort((a, b) => b.length - a.length);

function getCountryByPhone(phone) {
    if (!phone) return null;
    const clean = phone.replace(/[\s\-\(\)]/g, '');
    for (const prefix of _COUNTRY_PREFIXES_SORTED) {
        if (clean.startsWith(prefix)) return { ...COUNTRY_MAP[prefix], prefix };
    }
    // 00 ile ba≈ülayan numaralar
    if (clean.startsWith('00')) {
        const withPlus = '+' + clean.substring(2);
        for (const prefix of _COUNTRY_PREFIXES_SORTED) {
            if (withPlus.startsWith(prefix)) return { ...COUNTRY_MAP[prefix], prefix };
        }
    }
    return null;
}

function getCountryByPrefix(prefix) {
    if (!prefix) return null;
    const clean = prefix.replace(/[\s\-]/g, '');
    if (COUNTRY_MAP[clean]) return { ...COUNTRY_MAP[clean], prefix: clean };
    // + olmadan dene
    const withPlus = clean.startsWith('+') ? clean : '+' + clean;
    if (COUNTRY_MAP[withPlus]) return { ...COUNTRY_MAP[withPlus], prefix: withPlus };
    return null;
}

function getCountryLabel(prefix) {
    const country = getCountryByPrefix(prefix);
    if (!country) return 'üî¢ ' + prefix + 'x';
    return country.flag + ' ' + country.name;
}

// ============================================================
// DATA STORE
// ============================================================
const LEAD_STATUS_FILTER = '53AE02A5'; // Lead a≈üamasƒ±: "New" (Bitrix24 custom STATUS_ID)

let APP_DATA = {
    rules: [],
    personnel: [],
    logs: [],
    lastDistribution: null,
    settings: {
        poolUserId: 5668,
        poolUserName: 'Promed Database'
    }
};

let isDistributing = false;
let shouldStop = false;

// Enum ID ‚Üí Label lookup tablolarƒ± (init'te Bitrix24'ten doldurulur)
const ENUM_LABELS = {
    language: {},  // { "142": "German", "143": "English", ... }
    service: {}    // { "215": "Hair Transplant", "216": "Dental", ... }
};

// ============================================================
// BITRIX24 API WRAPPER
// ============================================================
const B24 = {
    ready: false,
    domain: '',

    init() {
        return new Promise((resolve) => {
            if (typeof BX24 !== 'undefined') {
                BX24.init(() => {
                    this.ready = true;
                    this.domain = BX24.getDomain();
                    document.getElementById('connectionDot').style.background = 'var(--green)';
                    document.getElementById('connectionStatus').textContent = `Baƒülƒ±: ${this.domain}`;
                    resolve(true);
                });
            } else {
                // Demo mode - Bitrix24 dƒ±≈üƒ±nda √ßalƒ±≈üƒ±yorsa
                this.ready = false;
                document.getElementById('connectionDot').style.background = 'var(--amber)';
                document.getElementById('connectionStatus').textContent = 'Demo Mod (Bitrix24 dƒ±≈üƒ±nda)';
                resolve(false);
            }
        });
    },

    call(method, params = {}) {
        return new Promise((resolve, reject) => {
            if (!this.ready) {
                resolve(this.demoResponse(method, params));
                return;
            }
            BX24.callMethod(method, params, (result) => {
                if (result.error()) {
                    const err = result.error();
                    const errMsg = err.ex ? err.ex.error_description || err.ex.error : JSON.stringify(err);
                    console.error(`API Error [${method}]:`, err);
                    reject(new Error(`${method}: ${errMsg}`));
                } else {
                    resolve(result);
                }
            });
        });
    },

    // Doƒürudan REST API √ßaƒürƒ±sƒ± ‚Äî BX24 SDK bypass, token expire olursa otomatik yeniler
    async restCall(method, params = {}, _retried = false) {
        if (!this.ready) return this.demoResponse(method, params);
        const auth = BX24.getAuth();
        const url = `https://${auth.domain}/rest/${method}.json`;
        const body = { ...params, auth: auth.access_token };
        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const json = await resp.json();
        if (json.error) {
            const errDesc = json.error_description || json.error || '';
            const isExpired = errDesc.toLowerCase().includes('expired') ||
                              json.error === 'expired_token' ||
                              (json.error !== 'QUERY_LIMIT_EXCEEDED' && errDesc.toLowerCase().includes('token'));
            // Token expire olduysa bir kez yenile ve tekrar dene
            if (isExpired && !_retried) {
                console.warn('Token expired, refreshing via BX24.refreshAuth...');
                try {
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => reject(new Error('refreshAuth timeout')), 15000);
                        BX24.refreshAuth((newAuth) => {
                            clearTimeout(timeout);
                            resolve(newAuth);
                        });
                    });
                    console.log('Token refreshed, retrying...');
                    return this.restCall(method, params, true);
                } catch (refreshErr) {
                    console.error('Token refresh failed:', refreshErr);
                    throw new Error(`${method}: Token s√ºresi doldu ve yenilenemedi ‚Äî ${errDesc}`);
                }
            }
            throw new Error(`${method}: ${errDesc}`);
        }
        return json;
    },

    // REST API batch √ßaƒürƒ±sƒ± ‚Äî 50 i≈ülem = 1 API hit
    async restBatch(commands) {
        const cmd = {};
        commands.forEach((c, i) => {
            const paramStr = this._flattenParams(c.params);
            cmd[`q${i}`] = `${c.method}?${paramStr}`;
        });
        return this.restCall('batch', { cmd });
    },

    // Nested objeleri query string'e √ßevirir: {fields: {ASSIGNED_BY_ID: 5}} ‚Üí fields[ASSIGNED_BY_ID]=5
    _flattenParams(obj, prefix) {
        const parts = [];
        for (const [k, v] of Object.entries(obj || {})) {
            const key = prefix ? `${prefix}[${k}]` : k;
            if (v !== null && typeof v === 'object' && !Array.isArray(v)) {
                parts.push(this._flattenParams(v, key));
            } else if (Array.isArray(v)) {
                v.forEach((item, idx) => {
                    parts.push(`${encodeURIComponent(key)}[${idx}]=${encodeURIComponent(item)}`);
                });
            } else {
                parts.push(`${encodeURIComponent(key)}=${encodeURIComponent(v)}`);
            }
        }
        return parts.join('&');
    },

    // start=-1 ile hƒ±zlƒ± sayfalama ‚Äî ID DESC (yeniden eskiye, COUNT yok)
    // onError: function(err, lastId) ‚Üí true=retry, false=stop | onError.resetErrors() ba≈üarƒ±lƒ± batch'te √ßaƒürƒ±lƒ±r
    async restFetchLeads(filter, select, order, onBatch, onError) {
        let lastId = null;
        let fetched = 0;
        const THROTTLE = 100;

        while (true) {
            try {
                const fetchFilter = { ...filter };
                if (lastId !== null) fetchFilter['<ID'] = lastId;

                const json = await this.restCall('crm.lead.list', {
                    filter: fetchFilter,
                    select,
                    order: { ID: 'DESC' },
                    start: -1
                });

                const data = json.result || [];
                if (data.length === 0) break;

                fetched += data.length;
                lastId = parseInt(data[data.length - 1].ID);

                // Ba≈üarƒ±lƒ± fetch ‚Üí ardƒ±≈üƒ±k hata sayacƒ±nƒ± sƒ±fƒ±rla
                if (onError && typeof onError.resetErrors === 'function') onError.resetErrors();

                const shouldContinue = await onBatch(data, fetched, null);
                if (!shouldContinue) break;

                if (data.length < 50) break;

                await new Promise(r => setTimeout(r, THROTTLE));
            } catch (err) {
                const shouldRetry = await onError(err, lastId);
                if (!shouldRetry) break;
            }
        }
        return fetched;
    },

    callBatch(commands) {
        return new Promise((resolve, reject) => {
            if (!this.ready) {
                resolve({});
                return;
            }
            BX24.callBatch(commands, (results) => {
                resolve(results);
            });
        });
    },

    // Demo modda test verileri
    demoResponse(method, params) {
        if (method === 'crm.lead.list') {
            return {
                data: () => [],
                total: () => Math.floor(Math.random() * 5000) + 500,
                more: () => false,
                next: () => null
            };
        }
        if (method === 'crm.lead.update') {
            return { data: () => true };
        }
        return { data: () => ({}) };
    },

    // Kural ve personel verilerini kaydet ‚Äî par√ßalƒ± (B24 boyut limiti a≈üƒ±mƒ±nƒ± √∂nler)
    async saveAppData() {
        const dataStr = JSON.stringify(APP_DATA);
        console.log('saveAppData: boyut=', dataStr.length);

        // 1) localStorage ‚Äî her zaman, g√ºvenilir, boyut limiti y√ºksek (~5MB)
        localStorage.setItem('lead_engine_data', dataStr);

        // 2) B24 appOption ‚Äî par√ßalƒ± kaydet (her key max ~2KB g√ºvenli)
        if (this.ready) {
            try {
                const rulesStr = JSON.stringify(APP_DATA.rules);
                const settingsStr = JSON.stringify(APP_DATA.settings);
                const logsStr = JSON.stringify((APP_DATA.logs || []).slice(-30));

                // Personeli 25'lik par√ßalara b√∂l (boyut limiti g√ºvenliƒüi)
                const CHUNK = 25;
                const pChunks = [];
                for (let i = 0; i < APP_DATA.personnel.length; i += CHUNK) {
                    pChunks.push(APP_DATA.personnel.slice(i, i + CHUNK));
                }

                // √ñnce par√ßa sayƒ±sƒ±nƒ± kaydet
                BX24.appOption.set('engine_p_count', String(pChunks.length));
                for (let c = 0; c < pChunks.length; c++) {
                    BX24.appOption.set('engine_p_' + c, JSON.stringify(pChunks[c]));
                }
                // Eski fazla par√ßalarƒ± temizle (√∂nceki kayƒ±tta daha fazla par√ßa varsa)
                for (let c = pChunks.length; c < pChunks.length + 5; c++) {
                    BX24.appOption.set('engine_p_' + c, '');
                }
                BX24.appOption.set('engine_rules', rulesStr);
                BX24.appOption.set('engine_settings', settingsStr);
                BX24.appOption.set('engine_logs', logsStr);
                // Eski tek-key formatƒ±nƒ± temizle
                BX24.appOption.set('engine_data', '');
                console.log('saveAppData: B24 OK');
            } catch(e) {
                console.error('saveAppData B24 hatasƒ±:', e);
            }
        }
    },

    async loadAppData() {
        let b24Data = null;
        let localData = null;

        // 1) localStorage'dan y√ºkle
        try {
            const local = localStorage.getItem('lead_engine_data');
            if (local) {
                localData = JSON.parse(local);
                console.log('localStorage: veri y√ºklendi');
            }
        } catch(e) { console.error('localStorage parse hatasƒ±:', e); }

        // 2) B24 appOption'dan y√ºkle (par√ßalƒ± format)
        if (this.ready) {
            try {
                // Yeni par√ßalƒ± format var mƒ± kontrol et
                let pCountStr = null;
                const pCountLoaded = await Promise.race([
                    new Promise(resolve => { BX24.appOption.get('engine_p_count', (v) => resolve(v || null)); }),
                    new Promise(resolve => setTimeout(() => resolve('__timeout__'), 2000))
                ]);
                if (pCountLoaded === '__timeout__') {
                    pCountStr = BX24.appOption.get('engine_p_count');
                } else {
                    pCountStr = pCountLoaded;
                }

                if (pCountStr && parseInt(pCountStr) > 0) {
                    // Par√ßalƒ± format ‚Äî personel par√ßalarƒ±nƒ± birle≈ütir
                    const pCount = parseInt(pCountStr);
                    let allPersonnel = [];
                    for (let c = 0; c < pCount; c++) {
                        const chunk = BX24.appOption.get('engine_p_' + c);
                        if (chunk) {
                            try { allPersonnel = allPersonnel.concat(JSON.parse(chunk)); } catch(e) {}
                        }
                    }
                    const rulesStr = BX24.appOption.get('engine_rules');
                    const settingsStr = BX24.appOption.get('engine_settings');
                    const logsStr = BX24.appOption.get('engine_logs');

                    b24Data = {
                        personnel: allPersonnel,
                        rules: rulesStr ? JSON.parse(rulesStr) : [],
                        settings: settingsStr ? JSON.parse(settingsStr) : APP_DATA.settings,
                        logs: logsStr ? JSON.parse(logsStr) : []
                    };
                    console.log('B24: veri y√ºklendi');
                } else {
                    // Eski tek-key format dene (geriye uyumluluk)
                    const oldValue = BX24.appOption.get('engine_data');
                    if (oldValue) {
                        try { b24Data = JSON.parse(oldValue); console.log('B24 eski format veri y√ºklendi'); } catch(e) {}
                    }
                }
            } catch(e) {
                console.error('loadAppData B24 hatasƒ±:', e);
            }
        }

        // 3) En fazla veriye sahip olanƒ± kullan
        const b24Count = (b24Data?.personnel?.length || 0) + (b24Data?.rules?.length || 0);
        const localCount = (localData?.personnel?.length || 0) + (localData?.rules?.length || 0);

        if (b24Data && localData) {
            APP_DATA = localCount >= b24Count ? localData : b24Data;
            console.log('Veri kar≈üƒ±la≈ütƒ±rma: B24=' + b24Count + ', Local=' + localCount + ' ‚Üí ' + (localCount >= b24Count ? 'localStorage' : 'B24') + ' kullanƒ±ldƒ±');
        } else if (localData) {
            APP_DATA = localData;
            console.log('Veri: sadece localStorage');
        } else if (b24Data) {
            APP_DATA = b24Data;
            console.log('Veri: sadece B24');
        } else {
            console.log('Veri: hi√ßbir kaynaktan y√ºklenemedi, varsayƒ±lan kullanƒ±lƒ±yor');
        }
    }
};

// ============================================================
// TABS
// ============================================================
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
    });
});

// ============================================================
// RULES MANAGEMENT
// ============================================================
function renderRules() {
    const tbody = document.getElementById('rulesTableBody');
    const empty = document.getElementById('rulesEmpty');
    const container = document.getElementById('rulesTableContainer');
    document.getElementById('rulesBadge').textContent = APP_DATA.rules.length;

    if (APP_DATA.rules.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
    }

    container.style.display = 'block';
    empty.style.display = 'none';

    // Sort by specificity (more conditions = higher priority)
    const sorted = APP_DATA.rules.map((r, i) => ({...r, originalIndex: i}));
    sorted.sort((a, b) => getSpecificity(b) - getSpecificity(a));

    function makeTags(items, cssClass, max) {
        if (!items || items.length === 0) return '<span style="color:var(--text-muted)">-</span>';
        const tags = items.slice(0, max).map(v => `<span class="tag ${cssClass}">${escapeHtml(v.trim())}</span>`).join('');
        const extra = items.length > max ? `<span class="tag tag-more">+${items.length - max}</span>` : '';
        return tags + extra;
    }

    function shortName(fullName) {
        const parts = fullName.trim().split(/\s+/);
        if (parts.length <= 1) return fullName;
        return parts[0] + ' ' + parts[parts.length - 1].charAt(0) + '.';
    }

    tbody.innerHTML = sorted.map((rule, displayIdx) => {
        const specificity = getSpecificity(rule);

        // Language tags (purple)
        const langs = rule.language ? rule.language.split(',').map(l => l.trim()).filter(Boolean) : [];
        const langDisplay = makeTags(langs, 'tag-lang', 2);

        // Phone prefix tags (amber) ‚Äî √ºlke bilgisiyle
        const phones = rule.phonePrefix ? rule.phonePrefix.split(',').map(p => p.trim()).filter(Boolean) : [];
        const phoneLabels = phones.map(p => getCountryLabel(p));
        const phoneDisplay = makeTags(phoneLabels, 'tag-phone', 2);

        // Service tags (green)
        const services = rule.service ? rule.service.split(',').map(s => s.trim()).filter(Boolean) : [];
        const serviceDisplay = makeTags(services, 'tag-service', 2);

        // Personnel pills
        let personnelDisplay;
        if (rule.personnel === 'ALL') {
            personnelDisplay = '<div class="personnel-compact"><span class="p-pill" style="background:var(--green-soft);color:var(--green-text);">T√úM AKTƒ∞F</span></div>';
        } else {
            const ids = rule.personnel.split(',').map(id => id.trim()).filter(Boolean);
            const names = ids.map(id => {
                const person = APP_DATA.personnel.find(p => p.bitrixId === parseInt(id));
                return person ? shortName(person.name) : 'ID:' + id;
            });
            const pills = names.slice(0, 2).map(n => `<span class="p-pill">${escapeHtml(n)}</span>`).join('');
            const extra = ids.length > 2 ? `<span class="p-pill-count">+${ids.length - 2} ki≈üi</span>` : '';
            personnelDisplay = '<div class="personnel-compact">' + pills + extra + '</div>';
        }

        const isActive = rule.active !== false;
        return `<tr style="${!isActive ? 'opacity:0.5;' : ''}">
            <td style="color:var(--text-faint);">${displayIdx + 1}</td>
            <td>
                <div class="rule-name">${escapeHtml(rule.name)}</div>
                <div class="rule-conditions">${specificity} ko≈üul</div>
            </td>
            <td>${langDisplay}</td>
            <td>${phoneDisplay}</td>
            <td>${serviceDisplay}</td>
            <td>${personnelDisplay}</td>
            <td><span class="kota-badge">${rule.quota || 200}</span></td>
            <td>
                <label class="toggle" title="${isActive ? 'Aktif ‚Äî tƒ±kla pasife al' : 'Pasif ‚Äî tƒ±kla aktife al'}">
                    <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleRuleActive(${rule.originalIndex})">
                    <span class="toggle-track"></span>
                    <span class="toggle-thumb"></span>
                </label>
            </td>
            <td>
                <div class="rule-actions">
                    <button class="btn btn-icon btn-ghost" onclick="runSingleRule(${rule.originalIndex})" title="√áalƒ±≈ütƒ±r">‚ñ∂</button>
                    <button class="btn btn-icon btn-ghost" onclick="editRule(${rule.originalIndex})" title="D√ºzenle">‚úèÔ∏è</button>
                    <button class="btn btn-icon btn-ghost" onclick="deleteRule(${rule.originalIndex})" title="Sil">üóë</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function getSpecificity(rule) {
    let count = 0;
    if (rule.language) count++;
    if (rule.phonePrefix) count++;
    if (rule.service) count++;
    return count;
}

// ============================================================
// PICKER RENDER FUNCTIONS
// ============================================================
function renderLanguagePicker(selectedValues) {
    const container = document.getElementById('ruleLanguagePicker');
    const selected = selectedValues ? selectedValues.split(',').map(v => v.trim()).filter(Boolean) : [];
    const entries = Object.entries(ENUM_LABELS.language);

    if (entries.length === 0) {
        container.innerHTML = '<div style="padding:10px;color:var(--text-muted);font-size:12px;">Enum deƒüerleri y√ºklenemedi. Bitrix24 baƒülantƒ±sƒ±nƒ± kontrol edin.</div>';
        return;
    }

    container.innerHTML = entries.map(([id, label]) => {
        const isChecked = selected.includes(label);
        const safeLabel = escapeHtml(label);
        return `<label class="picker-item${isChecked ? ' checked' : ''}">
            <input type="checkbox" name="ruleLanguage" value="${safeLabel}" ${isChecked ? 'checked' : ''} onchange="this.parentElement.classList.toggle('checked', this.checked)">
            ${safeLabel}
        </label>`;
    }).join('');
}

function renderServicePicker(selectedValues) {
    const container = document.getElementById('ruleServicePicker');
    const selected = selectedValues ? selectedValues.split(',').map(v => v.trim()).filter(Boolean) : [];
    const entries = Object.entries(ENUM_LABELS.service);

    if (entries.length === 0) {
        container.innerHTML = '<div style="padding:10px;color:var(--text-muted);font-size:12px;">Enum deƒüerleri y√ºklenemedi. Bitrix24 baƒülantƒ±sƒ±nƒ± kontrol edin.</div>';
        return;
    }

    container.innerHTML = entries.map(([id, label]) => {
        const isChecked = selected.includes(label);
        const safeLabel = escapeHtml(label);
        return `<label class="picker-item${isChecked ? ' checked' : ''}">
            <input type="checkbox" name="ruleService" value="${safeLabel}" ${isChecked ? 'checked' : ''} onchange="this.parentElement.classList.toggle('checked', this.checked)">
            ${safeLabel}
        </label>`;
    }).join('');
}

// ============================================================
// COUNTRY PICKER
// ============================================================
let _countrySelection = new Set();

function renderCountryPicker(selectedPrefixes) {
    _countrySelection = new Set();
    if (selectedPrefixes) {
        selectedPrefixes.split(',').map(v => v.trim()).filter(Boolean).forEach(p => _countrySelection.add(p));
    }
    document.getElementById('countryPickerSearch').value = '';
    document.getElementById('customPrefixInput').value = '';
    _renderCountryPickerFromState();
}

function addCustomPrefixes() {
    const input = document.getElementById('customPrefixInput');
    const raw = input.value.trim();
    if (!raw) return;
    raw.split(',').map(p => p.trim()).filter(Boolean).forEach(p => {
        const prefix = p.startsWith('+') ? p : '+' + p;
        _countrySelection.add(prefix);
    });
    input.value = '';
    _renderCountryPickerFromState();
}

function filterCountryPicker() {
    _renderCountryPickerFromState();
}

function _renderCountryPickerFromState() {
    const container = document.getElementById('ruleCountryPicker');
    const searchTerm = (document.getElementById('countryPickerSearch')?.value || '').toLowerCase();

    // √úlke listesinden gelen entries
    const entries = _COUNTRY_PREFIXES_SORTED.map(prefix => ({
        prefix,
        ...COUNTRY_MAP[prefix]
    }));

    // Se√ßili ama √ºlke listesinde olmayan custom prefix'ler (√∂r: +4)
    const knownPrefixes = new Set(_COUNTRY_PREFIXES_SORTED);
    const customEntries = [];
    _countrySelection.forEach(p => {
        if (!knownPrefixes.has(p)) {
            customEntries.push({ prefix: p, name: 'Geni≈ü: ' + p + 'x', flag: 'üî¢', code: '' });
        }
    });

    const all = [...customEntries, ...entries];

    // Arama filtresi
    const filtered = searchTerm
        ? all.filter(e => e.name.toLowerCase().includes(searchTerm) || e.prefix.includes(searchTerm) || (e.code && e.code.toLowerCase().includes(searchTerm)))
        : all;

    // Se√ßili olanlarƒ± √ºstte g√∂ster
    filtered.sort((a, b) => {
        const aSelected = _countrySelection.has(a.prefix) ? 0 : 1;
        const bSelected = _countrySelection.has(b.prefix) ? 0 : 1;
        if (aSelected !== bSelected) return aSelected - bSelected;
        return a.name.localeCompare(b.name, 'tr');
    });

    container.innerHTML = filtered.map(entry => {
        const isChecked = _countrySelection.has(entry.prefix);
        return '<label class="picker-item' + (isChecked ? ' checked' : '') + '">' +
            '<input type="checkbox" value="' + entry.prefix + '"' + (isChecked ? ' checked' : '') +
            ' onchange="onCountryCheckboxChange(\'' + entry.prefix + '\', this.checked); this.parentElement.classList.toggle(\'checked\', this.checked)">' +
            '<span>' + entry.flag + ' ' + escapeHtml(entry.name) + ' <span style="color:var(--text-muted);font-size:11px;">(' + entry.prefix + ')</span></span>' +
            '</label>';
    }).join('');
}

function onCountryCheckboxChange(prefix, checked) {
    if (checked) {
        _countrySelection.add(prefix);
    } else {
        _countrySelection.delete(prefix);
    }
}

function escapeHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderPersonnelPicker(selectedIds) {
    // State'i ba≈ülat
    _personnelSelection = new Set();
    _personnelAllMode = (selectedIds === 'ALL');

    if (!_personnelAllMode && selectedIds) {
        selectedIds.split(',').map(v => v.trim()).filter(Boolean).forEach(id => _personnelSelection.add(id));
    }

    // ALL checkbox g√ºncelle
    const allCheckbox = document.getElementById('rulePersonnelAll');
    if (allCheckbox) allCheckbox.checked = _personnelAllMode;

    const personnel = APP_DATA.personnel || [];
    if (personnel.length === 0) {
        document.getElementById('rulePersonnelPicker').innerHTML = '<div style="padding:10px;color:var(--text-muted);font-size:12px;">Hen√ºz personel eklenmemi≈ü. √ñnce Personel sekmesinden ekleyin.</div>';
        return;
    }

    console.log('renderPersonnelPicker: loaded');
    _renderPersonnelPickerFromState();
}

function togglePersonnelAll(checkbox) {
    _personnelAllMode = checkbox.checked;
    _renderPersonnelPickerFromState();
}

// Se√ßili personel ID'lerini DOM yerine JS'de tut
let _personnelSelection = new Set();
let _personnelAllMode = false;

function onPersonnelCheckboxChange(bitrixId, checked) {
    if (checked) {
        _personnelSelection.add(String(bitrixId));
    } else {
        _personnelSelection.delete(String(bitrixId));
    }
}

function filterPersonnelPicker() {
    _renderPersonnelPickerFromState();
}

function _renderPersonnelPickerFromState() {
    const container = document.getElementById('rulePersonnelPicker');
    const searchTerm = (document.getElementById('personnelSearch')?.value || '').toLowerCase();
    const personnel = APP_DATA.personnel || [];
    const filtered = searchTerm ? personnel.filter(p => p.name.toLowerCase().includes(searchTerm)) : personnel;

    container.innerHTML = filtered.map(p => {
        const isChecked = _personnelAllMode || _personnelSelection.has(String(p.bitrixId));
        const safeName = escapeHtml(p.name);
        const activeTag = p.active !== false ? '' : ' <span style="color:var(--red);font-size:11px;">(Pasif)</span>';
        return '<label class="picker-item' + (isChecked ? ' checked' : '') + '" data-id="' + p.bitrixId + '">' +
            '<input type="checkbox" value="' + p.bitrixId + '"' + (isChecked ? ' checked' : '') + (_personnelAllMode ? ' disabled' : '') +
            ' onchange="onPersonnelCheckboxChange(' + p.bitrixId + ', this.checked); this.parentElement.classList.toggle(\'checked\', this.checked)">' +
            '<span>' + safeName + ' <span style="color:var(--text-muted);font-size:11px;">(ID: ' + p.bitrixId + ')</span>' + activeTag + '</span>' +
            '</label>';
    }).join('');
}

function openRuleModal(index = -1) {
    document.getElementById('ruleEditIndex').value = index;

    // Reset search
    document.getElementById('personnelSearch').value = '';
    _lastPersonnelSearch = '';

    if (index >= 0) {
        const rule = APP_DATA.rules[index];
        console.log('openRuleModal: edit mode');
        document.getElementById('ruleModalTitle').textContent = 'Kural D√ºzenle';
        document.getElementById('ruleName').value = rule.name || '';
        document.getElementById('ruleQuota').value = rule.quota || 200;
        document.getElementById('ruleActive').value = rule.active !== false ? 'true' : 'false';
        renderLanguagePicker(rule.language || '');
        renderCountryPicker(rule.phonePrefix || '');
        renderServicePicker(rule.service || '');
        renderPersonnelPicker(rule.personnel || '');
    } else {
        document.getElementById('ruleModalTitle').textContent = 'Yeni Kural Ekle';
        document.getElementById('ruleName').value = '';
        document.getElementById('ruleQuota').value = 200;
        document.getElementById('ruleActive').value = 'true';
        renderLanguagePicker('');
        renderCountryPicker('');
        renderServicePicker('');
        renderPersonnelPicker('');
    }

    document.getElementById('ruleModal').classList.add('active');
    // Modal scroll'unu en √ºste al ‚Äî kural adƒ± alanƒ± g√∂r√ºns√ºn
    document.querySelector('#ruleModal .modal').scrollTop = 0;
    // Bitrix24 iframe'ini b√ºy√ºt ki modal sƒ±ƒüsƒ±n
    if (typeof BX24 !== 'undefined' && BX24.fitWindow) BX24.fitWindow();
}

function closeRuleModal() {
    document.getElementById('ruleModal').classList.remove('active');
}

function saveRule() {
    const index = parseInt(document.getElementById('ruleEditIndex').value);

    // Read selected languages from picker
    const selectedLangs = Array.from(document.querySelectorAll('#ruleLanguagePicker input[name="ruleLanguage"]:checked'))
        .map(cb => cb.value);

    // Read selected services from picker
    const selectedServices = Array.from(document.querySelectorAll('#ruleServicePicker input[name="ruleService"]:checked'))
        .map(cb => cb.value);

    // Read selected personnel from state (DOM'a baƒüƒ±mlƒ± deƒüil)
    let personnelValue;
    if (_personnelAllMode) {
        personnelValue = 'ALL';
    } else {
        personnelValue = Array.from(_personnelSelection).join(',');
    }

    const rule = {
        name: document.getElementById('ruleName').value.trim(),
        language: selectedLangs.join(','),
        phonePrefix: Array.from(_countrySelection).join(','),
        service: selectedServices.join(','),
        personnel: personnelValue,
        quota: parseInt(document.getElementById('ruleQuota').value) || 200,
        active: document.getElementById('ruleActive').value === 'true'
    };

    console.log('saveRule: saved');

    if (!rule.name) { alert('Kural adƒ± gerekli'); return; }
    if (!rule.personnel) { alert('En az bir personel se√ßin\n\nDebug: checkbox toplam=' +
        document.querySelectorAll('#rulePersonnelPicker input[name="rulePersonnel"]').length +
        ' checked=' + document.querySelectorAll('#rulePersonnelPicker input[name="rulePersonnel"]:checked').length);
        return;
    }

    if (index >= 0) {
        APP_DATA.rules[index] = rule;
    } else {
        APP_DATA.rules.push(rule);
    }

    B24.saveAppData();
    renderRules();
    updateBadges();
    closeRuleModal();
}

function editRule(index) { openRuleModal(index); }

function deleteRule(index) {
    if (!confirm(`"${APP_DATA.rules[index].name}" kuralƒ±nƒ± silmek istediƒüinize emin misiniz?`)) return;
    APP_DATA.rules.splice(index, 1);
    B24.saveAppData();
    renderRules();
}

function toggleRuleActive(index) {
    APP_DATA.rules[index].active = !(APP_DATA.rules[index].active !== false);
    B24.saveAppData();
    renderRules();
}

function runSingleRule(index) {
    if (isDistributing) { alert('Zaten bir daƒüƒ±tƒ±m √ßalƒ±≈üƒ±yor.'); return; }
    const rule = APP_DATA.rules[index];
    if (!rule) return;
    if (rule.active === false) {
        if (!confirm(`"${rule.name}" kuralƒ± pasif. Yine de √ßalƒ±≈ütƒ±rmak istiyor musunuz?`)) return;
    }
    // Daƒüƒ±tƒ±m sekmesine ge√ß
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('.tab[data-tab="distribution"]').classList.add('active');
    document.getElementById('tab-distribution').classList.add('active');
    startDistribution(index);
}

function exportRules() {
    const data = JSON.stringify(APP_DATA.rules, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `lead-rules-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importRules(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) { alert('Ge√ßersiz dosya formatƒ±'); return; }
            // Kural ≈üemasƒ± doƒürulama
            const validKeys = ['name','language','service','phonePrefix','personnel','active','priority'];
            const sanitized = imported.filter(rule => {
                if (typeof rule !== 'object' || rule === null || Array.isArray(rule)) return false;
                // __proto__ ve constructor pollution engelle
                if ('__proto__' in rule || 'constructor' in rule || 'prototype' in rule) return false;
                // Sadece bilinen anahtarlarƒ± tut
                Object.keys(rule).forEach(k => { if (!validKeys.includes(k)) delete rule[k]; });
                // String alanlarƒ± sanitize et
                ['name','language','service','phonePrefix','personnel'].forEach(k => {
                    if (rule[k] !== undefined) rule[k] = String(rule[k]).substring(0, 500);
                });
                return typeof rule.name === 'string' && rule.name.length > 0;
            });
            if (sanitized.length === 0) { alert('Ge√ßerli kural bulunamadƒ±'); return; }
            if (sanitized.length < imported.length) {
                alert(`${imported.length} kuraldan ${imported.length - sanitized.length} tanesi ge√ßersiz olduƒüu i√ßin atlandƒ±.`);
            }
            if (confirm(`${sanitized.length} kural i√ße aktarƒ±lacak. Mevcut kurallar korunacak. Devam?`)) {
                APP_DATA.rules = [...APP_DATA.rules, ...sanitized];
                B24.saveAppData();
                renderRules();
            }
        } catch(err) {
            alert('Dosya okunamadƒ±: ' + err.message);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// ============================================================
// PERSONNEL MANAGEMENT
// ============================================================
function renderPersonnel() {
    const grid = document.getElementById('personnelTableContainer');
    const empty = document.getElementById('personnelEmpty');
    document.getElementById('personnelBadge').textContent = APP_DATA.personnel.length;

    const activeCount = APP_DATA.personnel.filter(p => p.active !== false).length;
    const sub = document.getElementById('personnelSubtitle');
    if (sub) sub.textContent = activeCount + ' aktif / ' + APP_DATA.personnel.length + ' toplam';

    const pivotSection = document.getElementById('pivotSection');
    if (APP_DATA.personnel.length === 0) {
        grid.style.display = 'none';
        empty.style.display = 'block';
        if (pivotSection) pivotSection.style.display = 'none';
        return;
    }

    grid.style.display = 'grid';
    empty.style.display = 'none';
    if (pivotSection) pivotSection.style.display = 'block';

    grid.innerHTML = APP_DATA.personnel.map((p, i) => {
        const currentNew = p.currentNew || 0;
        const quota = p.quota || 200;
        const pct = Math.min(100, Math.round((currentNew / quota) * 100));
        const isActive = p.active !== false;

        // Avatar initials
        const nameParts = (p.name || '').trim().split(/\s+/);
        const initials = nameParts.length >= 2
            ? (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase()
            : (p.name || '?').substring(0, 2).toUpperCase();

        // Progress bar color
        let barClass = '';
        let countStyle = '';
        if (!isActive) {
            barClass = '';
            countStyle = 'opacity:0.3;';
        } else if (pct >= 100) {
            countStyle = 'color:var(--green);';
        } else if (pct >= 75) {
            barClass = '';
        } else if (pct >= 30) {
            barClass = 'mid';
            countStyle = 'color:var(--amber);';
        } else {
            barClass = 'low';
            countStyle = 'color:var(--red);';
        }

        const avatarStyle = isActive ? '' : ' style="background:var(--red-soft);color:var(--red);"';
        const nameStyle = isActive ? '' : ' style="opacity:0.5;"';
        const quotaLabel = isActive ? `/ ${quota}` : 'pasif';
        const quotaStyle = isActive ? '' : ' style="color:var(--red);"';

        return `<div class="person-card" ondblclick="editPersonnel(${i})">
            <div class="person-avatar"${avatarStyle}>${initials}</div>
            <div class="person-info">
                <div class="person-name"${nameStyle}>${escapeHtml(p.name)}</div>
                <div class="person-meta">
                    <span>ID: ${p.bitrixId}</span>
                </div>
                <div class="person-bar-track">
                    <div class="person-bar-fill ${barClass}" style="width:${pct}%;"></div>
                </div>
            </div>
            <div class="person-stats">
                <div class="person-count" style="${countStyle}">${currentNew}</div>
                <div class="person-quota"${quotaStyle}>${quotaLabel}</div>
            </div>
        </div>`;
    }).join('');
}

function openPersonnelModal(index = -1) {
    document.getElementById('personnelEditIndex').value = index;

    if (index >= 0) {
        const p = APP_DATA.personnel[index];
        document.getElementById('personnelModalTitle').textContent = 'Personel D√ºzenle';
        document.getElementById('personnelBitrixId').value = p.bitrixId || '';
        document.getElementById('personnelName').value = p.name || '';
        document.getElementById('personnelQuota').value = p.quota || 200;
        document.getElementById('personnelActive').value = p.active !== false ? 'true' : 'false';
    } else {
        document.getElementById('personnelModalTitle').textContent = 'Personel Ekle';
        document.getElementById('personnelBitrixId').value = '';
        document.getElementById('personnelName').value = '';
        document.getElementById('personnelQuota').value = 200;
        document.getElementById('personnelActive').value = 'true';
    }

    document.getElementById('personnelModal').classList.add('active');
}

function closePersonnelModal() {
    document.getElementById('personnelModal').classList.remove('active');
}

function savePersonnel() {
    const index = parseInt(document.getElementById('personnelEditIndex').value);
    const person = {
        bitrixId: parseInt(document.getElementById('personnelBitrixId').value),
        name: document.getElementById('personnelName').value.trim(),
        quota: parseInt(document.getElementById('personnelQuota').value) || 200,
        active: document.getElementById('personnelActive').value === 'true',
        currentNew: 0
    };

    if (!person.bitrixId) { alert('Bitrix ID gerekli'); return; }
    if (!person.name) { alert('Ad Soyad gerekli'); return; }

    if (index >= 0) {
        person.currentNew = APP_DATA.personnel[index].currentNew || 0;
        APP_DATA.personnel[index] = person;
    } else {
        // Check duplicate
        if (APP_DATA.personnel.some(p => p.bitrixId === person.bitrixId)) {
            alert('Bu Bitrix ID zaten kayƒ±tlƒ±'); return;
        }
        APP_DATA.personnel.push(person);
    }

    B24.saveAppData();
    renderPersonnel();
    closePersonnelModal();
}

function editPersonnel(index) { openPersonnelModal(index); }

function deletePersonnel(index) {
    if (!confirm(`"${APP_DATA.personnel[index].name}" personelini silmek istediƒüinize emin misiniz?`)) return;
    APP_DATA.personnel.splice(index, 1);
    B24.saveAppData();
    renderPersonnel();
}

async function syncPersonnel() {
    if (!B24.ready) {
        alert('Demo modda senkronizasyon yapƒ±lamaz. Bitrix24 i√ßinden a√ßƒ±n.');
        return;
    }

    debugLog('Personel senkronizasyonu ba≈ülatƒ±lƒ±yor...');

    try {
        // BX24 SDK result.next() callback zinciri ile t√ºm sayfalarƒ± √ßek
        debugLog('user.get deneniyor (result.next zinciri)...');

        const allUsers = await new Promise((resolve, reject) => {
            const users = [];
            let pageNum = 1;
            const timeout = setTimeout(() => {
                debugLog('Sync genel timeout (30s), ≈üu ana kadar: ' + users.length, true);
                resolve(users); // timeout olursa eldekiyle devam et
            }, 30000);

            BX24.callMethod('user.get', { filter: { ACTIVE: true } }, function(result) {
                if (result.error()) {
                    clearTimeout(timeout);
                    reject(new Error(result.error().ex ? result.error().ex.error_description : 'API error'));
                    return;
                }

                const data = result.data();
                users.push.apply(users, data);
                const total = result.total ? result.total() : '?';
                debugLog('Sayfa ' + pageNum + ': ' + data.length + ' kullanƒ±cƒ± geldi, toplam: ' + users.length + '/' + total);
                console.log('Sayfa', pageNum, ':', data.length, 'kullanƒ±cƒ±, toplam:', users.length, '/', total);
                pageNum++;

                if (result.more()) {
                    result.next(); // Aynƒ± callback'i sonraki sayfayla tekrar tetikler
                } else {
                    clearTimeout(timeout);
                    debugLog('T√ºm sayfalar tamamlandƒ±: ' + users.length + ' kullanƒ±cƒ± ‚úì');
                    resolve(users);
                }
            });
        });

        console.log('√áekilen toplam benzersiz user ID sayƒ±sƒ±:', new Set(allUsers.map(u => u.ID)).size);

        if (allUsers.length === 0) {
            debugLog('Hi√ß kullanƒ±cƒ± bulunamadƒ±!', true);
            alert('Hi√ß aktif kullanƒ±cƒ± bulunamadƒ±. API yanƒ±tƒ± bo≈ü d√∂nd√º.');
            return;
        }

        let added = 0;
        allUsers.forEach(u => {
            const exists = APP_DATA.personnel.some(p => p.bitrixId === parseInt(u.ID));
            if (!exists) {
                APP_DATA.personnel.push({
                    bitrixId: parseInt(u.ID),
                    name: ((u.NAME || '') + ' ' + (u.LAST_NAME || '')).trim(),
                    quota: 200,
                    active: true,
                    currentNew: 0
                });
                added++;
            }
        });

        debugLog('Kaydediliyor... (' + APP_DATA.personnel.length + ' personel)');
        await B24.saveAppData();
        renderPersonnel();
        updateBadges();
        debugLog('Senkronize: ' + allUsers.length + ' tarandƒ±, ' + added + ' eklendi, toplam ' + APP_DATA.personnel.length + ' personel kayƒ±tlƒ± ‚úì');
        alert('Senkronizasyon tamamlandƒ±.\n' + allUsers.length + ' kullanƒ±cƒ± tarandƒ±, ' + added + ' yeni eklendi.\nToplam kayƒ±tlƒ± personel: ' + APP_DATA.personnel.length);
    } catch(err) {
        debugLog('Senk hatasƒ±: ' + err.message, true);
        alert('Senkronizasyon hatasƒ±:\n\n' + (err.message || JSON.stringify(err)));
    }
}

// ============================================================
// DISTRIBUTION ENGINE
// ============================================================
function addLog(message, type = '') {
    const log = document.getElementById('progressLog');
    const time = new Date().toLocaleTimeString('tr-TR');
    const safeType = escapeHtml(type);
    const safeMsg = escapeHtml(message);
    log.innerHTML += `<div class="log-line ${safeType}">[${time}] ${safeMsg}</div>`;
    log.scrollTop = log.scrollHeight;
}

// ============================================================
// COUNTRY ANALYSIS PANEL
// ============================================================
let _countryScanCache = null;
let _countryScanRunning = false;

function toggleCountryPanel() {
    document.getElementById('countryPanel').classList.toggle('open');
}

async function startCountryScan() {
    if (_countryScanRunning) return;
    if (!B24.ready) { alert('Demo modda analiz yapƒ±lamaz.'); return; }
    _countryScanRunning = true;

    const scanBtn = document.getElementById('countryScanBtn');
    const rescanBtn = document.getElementById('countryRescanBtn');
    const statusEl = document.getElementById('countryScanStatus');
    const gridEl = document.getElementById('countryGrid');

    scanBtn.style.display = 'none';
    rescanBtn.style.display = 'none';
    statusEl.textContent = 'Taranƒ±yor...';
    gridEl.innerHTML = '';

    const countryCounts = {};
    let totalScanned = 0;
    let _scanEnrichNeeded = null;

    try {
        await B24.restFetchLeads(
            { ASSIGNED_BY_ID: APP_DATA.settings.poolUserId, STATUS_ID: LEAD_STATUS_FILTER },
            ['ID', 'PHONE'],
            { ID: 'DESC' },
            async (data, fetched) => {
                // ƒ∞lk batch'te PHONE kontrol√º
                if (_scanEnrichNeeded === null && data.length > 0) {
                    const samplePhone = extractPhone(data[0]);
                    _scanEnrichNeeded = !samplePhone;
                    if (_scanEnrichNeeded) statusEl.textContent = 'PHONE zenginle≈ütirme aktif ‚Äî taranƒ±yor...';
                }
                if (_scanEnrichNeeded) {
                    await enrichLeadsWithPhone(data);
                }

                for (const lead of data) {
                    const phone = extractPhone(lead);
                    const country = getCountryByPhone(phone);
                    const key = country ? country.prefix : '_unknown';
                    if (!countryCounts[key]) {
                        countryCounts[key] = {
                            count: 0,
                            name: country ? country.name : 'Bilinmeyen',
                            flag: country ? country.flag : '‚ùì',
                            prefix: country ? country.prefix : '?'
                        };
                    }
                    countryCounts[key].count++;
                }
                totalScanned = fetched;
                statusEl.textContent = totalScanned + ' lead tarandƒ±...';

                // Her 2000 lead'de grid'i g√ºncelle
                if (fetched % 2000 === 0) {
                    renderCountryGrid(countryCounts, totalScanned);
                }
                return true;
            },
            (() => {
                let errs = 0;
                const h = async (err) => {
                    errs++;
                    if (errs >= 3) { statusEl.textContent = '3 ardƒ±≈üƒ±k hata ‚Äî durdu: ' + err.message; return false; }
                    statusEl.textContent = `Hata (${errs}/3): ${err.message} ‚Äî 10s bekleniyor...`;
                    await new Promise(r => setTimeout(r, 10000));
                    return true;
                };
                h.resetErrors = () => { errs = 0; };
                return h;
            })()
        );

        _countryScanCache = countryCounts;
        renderCountryGrid(countryCounts, totalScanned);
        statusEl.textContent = totalScanned + ' lead tarandƒ± ‚Äî ' + Object.keys(countryCounts).length + ' √ºlke bulundu';
    } catch (err) {
        statusEl.textContent = 'Hata: ' + err.message;
    }

    _countryScanRunning = false;
    rescanBtn.style.display = 'inline-flex';
}

// ============================================================
// PREFIX TE≈ûHƒ∞S ‚Äî Belirli prefix'li leadleri havuzda ara, dil+servis bilgisiyle g√∂ster
// ============================================================
async function runPrefixDiag() {
    if (!B24.ready) { alert('Demo modda √ßalƒ±≈ümaz.'); return; }
    const prefix = (document.getElementById('diagPrefixInput').value || '+359').trim();
    const btn = document.getElementById('diagBtn');
    const statusEl = document.getElementById('diagStatus');
    const resultsEl = document.getElementById('diagResults');

    btn.disabled = true;
    statusEl.textContent = 'Taranƒ±yor...';
    resultsEl.innerHTML = '';

    const prefixClean = prefix.replace(/^\+/, '');
    const variants = [...new Set([prefix, '+' + prefixClean, '00' + prefixClean, prefixClean])];

    let found = [];
    let scanned = 0;

    try {
        // Dil ve servis filtresi OLMADAN havuzu tara
        await B24.restFetchLeads(
            { ASSIGNED_BY_ID: APP_DATA.settings.poolUserId, STATUS_ID: LEAD_STATUS_FILTER },
            ['ID', 'PHONE', FIELD_MAP.language, FIELD_MAP.service, FIELD_MAP.leadCreatedTime],
            { ID: 'DESC' },
            async (data, fetched) => {
                // PHONE enrichment gerekiyorsa
                let needEnrich = false;
                if (data.length > 0 && !extractPhone(data[0])) {
                    needEnrich = true;
                    await enrichLeadsWithPhone(data);
                }

                for (const lead of data) {
                    const phone = extractPhone(lead);
                    if (variants.some(v => phone.startsWith(v))) {
                        const langId = lead[FIELD_MAP.language];
                        const svcId = lead[FIELD_MAP.service];
                        const langLabel = langId ? enumToLabel('language', langId) : '(bo≈ü)';
                        const svcLabel = svcId ? enumToLabel('service', svcId) : '(bo≈ü)';
                        found.push({
                            id: lead.ID,
                            phone: phone,
                            lang: langLabel,
                            langId: langId || '-',
                            svc: svcLabel,
                            svcId: svcId || '-',
                            date: lead[FIELD_MAP.leadCreatedTime] || ''
                        });
                    }
                }

                scanned = fetched;
                statusEl.textContent = `${scanned} tarandƒ±, ${found.length} ${prefix} bulundu...`;

                // Her 2000'de ara sonu√ßlarƒ± g√∂ster
                if (fetched % 2000 === 0 && found.length > 0) {
                    _renderDiagResults(found, prefix, scanned);
                }

                // 30 tane bulduysa dur (te≈ühis i√ßin yeterli)
                if (found.length >= 30) return false;
                return true;
            },
            (() => {
                let errs = 0;
                const h = async (err) => {
                    errs++;
                    if (errs >= 3) { statusEl.textContent = '3 ardƒ±≈üƒ±k hata ‚Äî durdu: ' + err.message; return false; }
                    statusEl.textContent = `Hata (${errs}/3): ${err.message} ‚Äî 10s bekleniyor...`;
                    await new Promise(r => setTimeout(r, 10000));
                    return true;
                };
                h.resetErrors = () => { errs = 0; };
                return h;
            })()
        );

        if (found.length === 0) {
            resultsEl.innerHTML = `<div style="color:var(--red);padding:12px;">‚ùå ${scanned} lead tarandƒ± ‚Äî ${prefix} ile ba≈ülayan telefon bulunamadƒ±!</div>`;
            statusEl.textContent = `${scanned} tarandƒ±, 0 bulundu`;
        } else {
            _renderDiagResults(found, prefix, scanned);
            statusEl.textContent = `${scanned} tarandƒ±, ${found.length} ${prefix} bulundu ‚úì`;
        }
    } catch (err) {
        statusEl.textContent = 'Hata: ' + err.message;
    }

    btn.disabled = false;
}

function _renderDiagResults(found, prefix, scanned) {
    const el = document.getElementById('diagResults');
    // Dil kƒ±rƒ±lƒ±mƒ± √∂zet
    const langBreakdown = {};
    found.forEach(f => {
        const key = f.lang + ' (ID:' + f.langId + ')';
        langBreakdown[key] = (langBreakdown[key] || 0) + 1;
    });
    const country = getCountryByPrefix(prefix);
    const countryLabel = country ? country.flag + ' ' + country.name : prefix;

    let html = `<div style="margin-bottom:8px;font-weight:600;color:var(--text-primary);">${escapeHtml(countryLabel)}: ${found.length} lead bulundu (${scanned} tarandƒ±)</div>`;

    // Dil daƒüƒ±lƒ±mƒ±
    html += '<div style="margin-bottom:10px;">';
    html += '<span style="color:var(--text-faint);">Dil daƒüƒ±lƒ±mƒ±:</span> ';
    html += Object.entries(langBreakdown).sort((a,b) => b[1]-a[1]).map(([lang, count]) =>
        `<span style="background:var(--accent-soft);color:var(--accent-text);padding:2px 8px;border-radius:4px;margin:2px;">${escapeHtml(lang)}: ${count}</span>`
    ).join(' ');
    html += '</div>';

    // ƒ∞lk 15 lead detay
    html += '<table style="width:100%;font-size:11px;"><tr style="color:var(--text-faint);"><td>Lead ID</td><td>Telefon</td><td>Dil</td><td>Dil ID</td><td>Servis</td><td>Tarih</td></tr>';
    found.slice(0, 15).forEach(f => {
        html += `<tr><td>${escapeHtml(String(f.id))}</td><td>${escapeHtml(f.phone)}</td><td><strong>${escapeHtml(f.lang)}</strong></td><td>${escapeHtml(String(f.langId))}</td><td>${escapeHtml(f.svc)}</td><td>${escapeHtml(f.date?.substring(0, 10) || '')}</td></tr>`;
    });
    html += '</table>';
    if (found.length > 15) {
        html += `<div style="color:var(--text-muted);margin-top:4px;">... ve ${found.length - 15} lead daha</div>`;
    }

    el.innerHTML = html;
}

function renderCountryGrid(countryCounts, total) {
    const gridEl = document.getElementById('countryGrid');
    const sorted = Object.values(countryCounts).sort((a, b) => b.count - a.count);
    const maxCount = sorted.length > 0 ? sorted[0].count : 1;

    gridEl.innerHTML = sorted.map(entry => {
        const pct = total > 0 ? ((entry.count / total) * 100).toFixed(1) : '0';
        const barWidth = Math.max(2, Math.round((entry.count / maxCount) * 100));
        return `<div class="country-card">
            <div class="country-card-top">
                <span class="country-card-flag">${entry.flag}</span>
                <div>
                    <div class="country-card-name">${escapeHtml(entry.name)}</div>
                    <div class="country-card-prefix">${entry.prefix}</div>
                </div>
            </div>
            <div class="country-card-count">${entry.count}</div>
            <div class="country-bar-track">
                <div class="country-bar-fill" style="width:${barWidth}%"></div>
            </div>
            <div class="country-card-pct">${pct}%</div>
        </div>`;
    }).join('');
}

function updateProgress(percent, detail) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressPercent').textContent = percent + '%';
    document.getElementById('progressDetail').textContent = detail;
}

async function startDistribution(singleRuleIndex) {
    if (isDistributing) return;
    if (APP_DATA.rules.length === 0) { alert('√ñnce en az bir kural tanƒ±mlayƒ±n.'); return; }
    if (APP_DATA.personnel.length === 0) { alert('√ñnce personel ekleyin.'); return; }

    const isDryRun = document.getElementById('dryRunCheck').checked;
    const isSingleRule = singleRuleIndex !== undefined && singleRuleIndex !== null;
    isDistributing = true;
    shouldStop = false;

    document.getElementById('startDistBtn').disabled = true;
    document.getElementById('progressContainer').classList.add('active');
    document.getElementById('progressLog').innerHTML = '';
    _phoneCache.clear(); // Phone cache temizle
    _enrichDebugDone = false;
    if (typeof BX24 !== 'undefined' && BX24.fitWindow) BX24.fitWindow();
    const singleRuleName = isSingleRule ? APP_DATA.rules[singleRuleIndex].name : '';
    document.getElementById('progressTitle').textContent = isDryRun
        ? (isSingleRule ? `üß™ Dry Run: ${singleRuleName}` : 'üß™ Dry Run Daƒüƒ±tƒ±m')
        : (isSingleRule ? `‚ö° Canlƒ±: ${singleRuleName}` : '‚ö° Canlƒ± Daƒüƒ±tƒ±m');

    const startTime = Date.now();
    let totalDistributed = 0;
    let totalErrors = 0;
    let totalUnmatched = 0;
    const details = {};

    try {
        // Step 1: Kurallardaki personelleri belirle (sadece onlarƒ± sorgula)
        const activePersonnel = APP_DATA.personnel.filter(p => p.active !== false);
        const activeRules = isSingleRule
            ? [APP_DATA.rules[singleRuleIndex]]
            : APP_DATA.rules.filter(r => r.active !== false);

        // Kurallarda kullanƒ±lan benzersiz personel ID'leri
        const rulePersonnelIds = new Set();
        activeRules.forEach(rule => {
            if (rule.personnel === 'ALL') {
                activePersonnel.forEach(p => rulePersonnelIds.add(p.bitrixId));
            } else if (rule.personnel) {
                rule.personnel.split(',').forEach(id => rulePersonnelIds.add(parseInt(id.trim())));
            }
        });

        // Sadece kurallardaki aktif personeller
        const ruleActivePersonnel = activePersonnel.filter(p => rulePersonnelIds.has(p.bitrixId));
        addLog(ruleActivePersonnel.length + ' personel kurallarda aktif, lead sayƒ±larƒ± sorgulanƒ±yor...', 'info');
        updateProgress(5, ruleActivePersonnel.length + ' personel sorgulanƒ±yor...');

        addLog('Kullanƒ±lan lead a≈üamasƒ±: ' + LEAD_STATUS_FILTER, 'info');

        // Personel lead sayƒ±larƒ±nƒ± BATCH ile sorgula (tek API √ßaƒürƒ±sƒ±)
        try {
            const countQueries = ruleActivePersonnel.map(p => ({
                method: 'crm.lead.list',
                params: { filter: { ASSIGNED_BY_ID: p.bitrixId, STATUS_ID: LEAD_STATUS_FILTER }, select: ['ID'], start: 0 }
            }));
            const BATCH_SZ = 50;
            for (let bi = 0; bi < countQueries.length; bi += BATCH_SZ) {
                if (shouldStop) break;
                const chunk = countQueries.slice(bi, bi + BATCH_SZ);
                const batchResult = await B24.restBatch(chunk);
                const bRes = batchResult.result || batchResult;
                const resTotal = bRes.result_total || {};
                const resData = bRes.result || {};
                chunk.forEach((q, idx) => {
                    const person = ruleActivePersonnel[bi + idx];
                    const key = `q${idx}`;
                    let count = resTotal[key];
                    if (count === undefined || count === null) {
                        const d = resData[key];
                        count = Array.isArray(d) ? d.length : 0;
                    }
                    const mainIdx = APP_DATA.personnel.findIndex(p => p.bitrixId === person.bitrixId);
                    if (mainIdx >= 0) APP_DATA.personnel[mainIdx].currentNew = count;
                    person.currentNew = count;
                    const need = Math.max(0, (person.quota || 200) - count);
                    addLog(person.name + ' (ID:' + person.bitrixId + '): ' + count + ' NEW, kota: ' + (person.quota || 200) + ', ihtiya√ß: ' + need);
                });
                updateProgress(5 + Math.round(((bi + chunk.length) / countQueries.length) * 15), 'Personel durumlarƒ±...');
            }
        } catch(err) {
            addLog('Personel batch sorgusu hatasƒ±: ' + err.message + ' ‚Äî tek tek deneniyor...', 'error');
            for (let i = 0; i < ruleActivePersonnel.length; i++) {
                if (shouldStop) break;
                const person = ruleActivePersonnel[i];
                try {
                    const result = await B24.call('crm.lead.list', {
                        filter: { ASSIGNED_BY_ID: person.bitrixId, STATUS_ID: LEAD_STATUS_FILTER },
                        select: ['ID'], start: 0
                    });
                    const count = result.total ? result.total() : 0;
                    const mainIdx = APP_DATA.personnel.findIndex(p => p.bitrixId === person.bitrixId);
                    if (mainIdx >= 0) APP_DATA.personnel[mainIdx].currentNew = count;
                    person.currentNew = count;
                } catch(e) { addLog(person.name + ' sorgulanamadƒ±: ' + e, 'error'); }
            }
        }

        if (shouldStop) { addLog('Daƒüƒ±tƒ±m durduruldu.', 'error'); finishDistribution(startTime, totalDistributed, totalErrors, totalUnmatched, isDryRun, details); return; }

        // Step 2: Kurallarƒ± hazƒ±rla
        activeRules.sort((a, b) => getSpecificity(b) - getSpecificity(a));
        addLog(`${activeRules.length} aktif kural y√ºklendi (spesifikten genele sƒ±ralƒ±).`, 'info');

        // Personel ihtiya√ß haritasƒ± (sadece kurallardaki personel)
        const personnelNeeds = {};
        ruleActivePersonnel.forEach(p => {
            const quota = p.quota || 200;
            const need = Math.max(0, quota - (p.currentNew || 0));
            personnelNeeds[p.bitrixId] = { ...p, need: need, assigned: 0 };
        });

        // Round-robin hazƒ±rlƒ±k
        const ruleRobinIndex = {};
        const rulePersonnelMap = {};
        activeRules.forEach(rule => {
            rulePersonnelMap[rule.name] = getRulePersonnel(rule, activePersonnel);
            ruleRobinIndex[rule.name] = 0;
        });

        const totalNeedAll = Object.values(personnelNeeds).reduce((s, p) => s + p.need, 0);
        addLog('Toplam ihtiya√ß: ' + totalNeedAll + ' lead', 'info');

        // Enum label ‚Üí ID ters lookup fonksiyonu
        function labelToEnumIds(enumType, labelsCsv) {
            if (!labelsCsv) return null;
            const labels = labelsCsv.split(',').map(l => l.trim().toLowerCase());
            const ids = [];
            for (const [id, label] of Object.entries(ENUM_LABELS[enumType] || {})) {
                if (labels.some(l => label.toLowerCase().includes(l))) ids.push(id);
            }
            return ids.length > 0 ? ids : null;
        }

        // Step 3: Her kural i√ßin SERVER-SIDE filtreli √ßekim + atama
        const assignments = [];
        const assignedLeadIds = new Set();
        let totalFetched = 0;

        for (let ruleIdx = 0; ruleIdx < activeRules.length; ruleIdx++) {
            const rule = activeRules[ruleIdx];
            if (shouldStop) break;

            const rulePersonnel = rulePersonnelMap[rule.name];
            if (!rulePersonnel || rulePersonnel.length === 0) continue;

            const ruleNeed = rulePersonnel.reduce((s, p) => {
                const pn = personnelNeeds[p.bitrixId];
                return s + (pn ? Math.max(0, pn.need - pn.assigned) : 0);
            }, 0);
            if (ruleNeed <= 0) { addLog(`"${rule.name}": t√ºm kotalar dolu, atlanƒ±yor.`); continue; }

            // Temel API filtresi
            const baseFilter = {
                ASSIGNED_BY_ID: APP_DATA.settings.poolUserId,
                STATUS_ID: LEAD_STATUS_FILTER,
            };
            const langIds = labelToEnumIds('language', rule.language);
            if (langIds) baseFilter[FIELD_MAP.language] = langIds;
            const serviceIds = labelToEnumIds('service', rule.service);
            if (serviceIds) baseFilter[FIELD_MAP.service] = serviceIds;
            const phonePrefixes = rule.phonePrefix ? rule.phonePrefix.split(',').map(p => p.trim()).filter(Boolean) : [];
            const hasPrefixFilter = phonePrefixes.length > 0;
            let ruleSampleCount = 0;

            const filterDesc = [];
            if (langIds) filterDesc.push('dil:' + langIds.length + ' IDs=[' + langIds.join(',') + '] ‚Üê "' + (rule.language || '') + '"');
            if (serviceIds) filterDesc.push('servis:' + serviceIds.length + ' IDs=[' + serviceIds.slice(0,5).join(',') + (serviceIds.length > 5 ? '...' : '') + ']');
            if (phonePrefixes.length > 0) filterDesc.push('tel:' + phonePrefixes.join(','));
            addLog(`"${rule.name}" [${filterDesc.join(', ')}] ‚Äî ihtiya√ß: ${ruleNeed} lead`, 'info');

            const fetchStart = Date.now();
            let ruleFetched = 0;
            let ruleMatched = 0;
            let allRuleLeads = [];

            // ‚ïê‚ïê‚ïê LEAD √áEKME: Dil+Servis server-side, Prefix client-side stream ‚ïê‚ïê‚ïê
            // Bitrix24 =%UF_CRM prefix filtresini desteklemiyor ‚Äî g√ºvenilir yol client-side
            const MATCH_TARGET = hasPrefixFilter ? ruleNeed : Infinity;
            const prefixVariants = hasPrefixFilter ? phonePrefixes.flatMap(prefix => {
                const raw = prefix.replace(/^\+/, '').replace(/^00/, '');
                return [...new Set([prefix, '+' + raw, '00' + raw, raw])];
            }) : [];

            addLog(`  Leadler √ßekiliyor (dil+servis: server, ${hasPrefixFilter ? 'prefix: client-stream [' + prefixVariants.join('/') + '], hedef: ' + MATCH_TARGET : 'prefix yok'})...`, 'info');
            updateProgress(30, 'Leadler √ßekiliyor...');

            let _phoneEnrichNeeded = null; // null=hen√ºz bilinmiyor, true/false sonra

            await B24.restFetchLeads(
                baseFilter,
                ['ID', 'PHONE', FIELD_MAP.leadCreatedTime],
                { ID: 'DESC' },
                async (data, fetched) => {
                    ruleFetched = fetched;

                    // ƒ∞lk batch'te PHONE alanƒ±nƒ± kontrol et
                    if (_phoneEnrichNeeded === null && data.length > 0) {
                        const sample = data[0];
                        const allKeys = Object.keys(sample).join(', ');
                        const samplePhone = extractPhone(sample);
                        addLog(`  DEBUG ilk lead ID=${sample.ID} | keys=[${allKeys}]`, 'info');
                        addLog(`  DEBUG PHONE raw=${JSON.stringify(sample.PHONE)?.substring(0, 150)} | extract="${samplePhone}"`, 'info');
                        if (!samplePhone) {
                            _phoneEnrichNeeded = true;
                            _enrichDebugDone = false; // enrichment debug'ƒ± da g√∂ster
                            addLog(`  ‚ö† PHONE bo≈ü ‚Üí crm.lead.get zenginle≈ütirme AKTƒ∞F`, 'info');
                        } else {
                            _phoneEnrichNeeded = false;
                            addLog(`  ‚úì PHONE mevcut: ${samplePhone}`, 'success');
                        }
                    }

                    // PHONE bo≈ü geliyorsa batch crm.lead.get ile doldur
                    if (_phoneEnrichNeeded) {
                        await enrichLeadsWithPhone(data);
                        // Zenginle≈ütirme sonrasƒ± kontrol (ilk batch)
                        if (fetched <= 50 && data.length > 0) {
                            const afterSample = data[0];
                            const afterPhone = extractPhone(afterSample);
                            addLog(`  DEBUG zenginle≈ütirme sonrasƒ±: Lead ${afterSample.ID} ‚Üí phone="${afterPhone}" _phone="${afterSample._phone || ''}"`, 'info');
                            // ƒ∞lk 3 lead'in telefonlarƒ±nƒ± g√∂ster
                            const phones3 = data.slice(0, 3).map(l => `${l.ID}:"${extractPhone(l)}"`).join(', ');
                            addLog(`  DEBUG ilk 3 lead: ${phones3}`, 'info');
                        }
                    }

                    if (hasPrefixFilter) {
                        // Client-side prefix filtresi ‚Äî sadece e≈üle≈üenleri tut
                        let batchMatches = 0;
                        for (const lead of data) {
                            const phone = extractPhone(lead);
                            if (prefixVariants.some(v => phone.startsWith(v))) {
                                allRuleLeads.push(lead);
                                batchMatches++;
                                // ƒ∞lk 3 e≈üle≈ümeyi logla
                                if (allRuleLeads.length <= 3) {
                                    const matchCountry = getCountryByPhone(phone);
                                    const matchCountryStr = matchCountry ? ' ' + matchCountry.flag + matchCountry.name : '';
                                    addLog(`  ‚úì E≈üle≈üme #${allRuleLeads.length}: Lead ${lead.ID} tel=${phone}${matchCountryStr}`, 'success');
                                }
                            }
                        }

                        // Yeterli e≈üle≈üme ‚Üí erken dur
                        if (allRuleLeads.length >= MATCH_TARGET) {
                            const elapsed = Math.round((Date.now() - fetchStart) / 1000);
                            addLog(`  ‚úì ${allRuleLeads.length} prefix e≈üle≈ümesi bulundu, ${fetched} tarandƒ± [${elapsed}s] ‚Äî erken durdurma`, 'success');
                            return false;
                        }

                        if (fetched % 2000 === 0) {
                            const elapsed = Math.round((Date.now() - fetchStart) / 1000);
                            addLog(`  ${fetched} tarandƒ± ‚Üí ${allRuleLeads.length} e≈üle≈üme [${elapsed}s]`);
                        }
                        updateProgress(30, `${fetched} tarandƒ±, ${allRuleLeads.length} e≈üle≈üme...`);
                    } else {
                        // Prefix filtresi yok ‚Äî t√ºm leadleri topla
                        allRuleLeads.push(...data);
                        if (fetched % 1000 === 0 || data.length < 50) {
                            const elapsed = Math.round((Date.now() - fetchStart) / 1000);
                            addLog(`  ${fetched} lead √ßekildi [${elapsed}s]`);
                        }
                        updateProgress(30, `${fetched} lead √ßekildi...`);
                    }
                    return !shouldStop;
                },
                (() => {
                    let consecutiveErrors = 0;
                    const MAX_RETRIES = 5;
                    const handler = async (err, currentStart) => {
                        consecutiveErrors++;
                        const msg = err.message || '';
                        const isTokenErr = msg.toLowerCase().includes('expired') || msg.toLowerCase().includes('token');
                        if (isTokenErr) {
                            addLog(`  Token yenilendi, devam ediliyor... (ID>${currentStart})`, 'info');
                            consecutiveErrors = 0;
                            await new Promise(r => setTimeout(r, 2000));
                            return true;
                        }
                        if (consecutiveErrors >= MAX_RETRIES) {
                            addLog(`  ${MAX_RETRIES} ardƒ±≈üƒ±k hata ‚Äî tarama durduruluyor (ID>${currentStart})`, 'error');
                            return false;
                        }
                        addLog(`  API hatasƒ± (${consecutiveErrors}/${MAX_RETRIES}) (ID>${currentStart}): ${msg}`, 'error');
                        addLog(`  ${10 * consecutiveErrors}s bekleniyor...`, 'info');
                        await new Promise(r => setTimeout(r, 10000 * consecutiveErrors));
                        return true;
                    };
                    handler.resetErrors = () => { consecutiveErrors = 0; };
                    return handler;
                })()
            );

            const fetchSec = Math.round((Date.now() - fetchStart) / 1000);
            addLog(`  ${allRuleLeads.length} lead ${fetchSec}s'de toplandƒ± (${ruleFetched} API sonucu).`, 'info');

            if (shouldStop) { addLog(`"${rule.name}": durduruldu.`, 'error'); continue; }

            // Faz 2: leadCreatedTime'a g√∂re sƒ±rala (yeniden eskiye)
            allRuleLeads.sort((a, b) => {
                const timeA = a[FIELD_MAP.leadCreatedTime] || '';
                const timeB = b[FIELD_MAP.leadCreatedTime] || '';
                return timeB.localeCompare(timeA);
            });
            addLog(`  ${allRuleLeads.length} lead tarihe g√∂re sƒ±ralandƒ±, atama ba≈ülƒ±yor...`, 'info');

            // Faz 3: Sƒ±ralƒ± listeyi i≈üle ‚Äî round-robin atama
            totalFetched += ruleFetched;

            for (const lead of allRuleLeads) {
                if (shouldStop) break;
                if (assignedLeadIds.has(lead.ID)) continue;

                let assignee = null;
                for (let attempt = 0; attempt < rulePersonnel.length; attempt++) {
                    const idx = (ruleRobinIndex[rule.name] + attempt) % rulePersonnel.length;
                    const candidate = rulePersonnel[idx];
                    const pn = personnelNeeds[candidate.bitrixId];
                    if (pn && pn.need > pn.assigned) {
                        assignee = candidate;
                        ruleRobinIndex[rule.name] = idx + 1;
                        break;
                    }
                }

                if (!assignee) {
                    addLog(`  T√ºm kotalar doldu! ${ruleMatched} lead atandƒ±.`, 'success');
                    break;
                }

                assignedLeadIds.add(lead.ID);
                assignments.push({ leadId: lead.ID, personnelId: assignee.bitrixId, personnelName: assignee.name, ruleName: rule.name });
                personnelNeeds[assignee.bitrixId].assigned++;
                totalDistributed++;
                ruleMatched++;

                if (ruleSampleCount < 5) {
                    const phone = extractPhone(lead);
                    const leadTime = lead[FIELD_MAP.leadCreatedTime] || 'tarih yok';
                    const assignCountry = getCountryByPhone(phone);
                    const assignCountryStr = assignCountry ? ' ' + assignCountry.flag + assignCountry.name : '';
                    addLog(`  üìã Lead ${lead.ID}: tel=${phone}${assignCountryStr} ‚Üí ${assignee.name} [${leadTime}]`, 'info');
                    ruleSampleCount++;
                }
                if (!details[rule.name]) details[rule.name] = {};
                if (!details[rule.name][assignee.name]) details[rule.name][assignee.name] = 0;
                details[rule.name][assignee.name]++;
            }

            allRuleLeads = null; // Bellek temizle
            addLog(`"${rule.name}": ${ruleMatched} lead ${fetchSec}s ‚úì`, 'success');
            updateProgress(25 + Math.round((totalDistributed / Math.max(totalNeedAll, 1)) * 55), `${totalDistributed}/${totalNeedAll} atandƒ±`);

            // Kurallar arasƒ± kƒ±sa bekleme
            if (ruleIdx < activeRules.length - 1 && ruleFetched > 0) {
                await new Promise(r => setTimeout(r, 500));
            }
        }

        document.getElementById('statPoolLeads').textContent = totalFetched;

        if (totalDistributed === 0) {
            addLog('E≈üle≈üen lead bulunamadƒ±.', 'error');
            finishDistribution(startTime, 0, 0, totalUnmatched, isDryRun, details);
            return;
        }

        addLog(`E≈üle≈ütirme tamamlandƒ±: ${totalDistributed} atanacak, ${totalUnmatched} e≈üle≈ümeyen (${totalFetched} √ßekildi).`, 'success');

        if (shouldStop) { addLog('Daƒüƒ±tƒ±m durduruldu.', 'error'); finishDistribution(startTime, totalDistributed, totalErrors, totalUnmatched, isDryRun, details); return; }

        // Step 7: Execute assignments via REST batch API (25 g√ºncelleme = 1 API √ßaƒürƒ±sƒ±)
        if (!isDryRun && assignments.length > 0) {
            const BATCH_SIZE = 50;
            const totalBatches = Math.ceil(assignments.length / BATCH_SIZE);
            addLog(`Bitrix24 g√ºncellemeleri ba≈ülatƒ±lƒ±yor (${assignments.length} lead, ${totalBatches} batch √ó ${BATCH_SIZE})...`, 'info');
            updateProgress(80, 'Leadler atanƒ±yor...');

            let assignedCount = 0;
            let errorCount = 0;
            let retryQueue = []; // OPERATION_TIME_LIMIT hatasƒ± alan leadler

            for (let i = 0; i < assignments.length; i += BATCH_SIZE) {
                if (shouldStop) break;

                const chunk = assignments.slice(i, i + BATCH_SIZE);
                const commands = chunk.map(a => ({
                    method: 'crm.lead.update',
                    params: { ID: a.leadId, fields: { ASSIGNED_BY_ID: a.personnelId } }
                }));

                let retryCount = 0;
                let batchDone = false;
                while (retryCount < 3 && !batchDone) {
                    try {
                        const result = await B24.restBatch(commands);
                        const batchResult = result.result || {};
                        const successResults = batchResult.result || {};
                        const errorResults = batchResult.result_error || {};

                        assignedCount += Object.keys(successResults).length;

                        // OPERATION_TIME_LIMIT olanlarƒ± retry kuyruƒüuna al
                        let timeLimitHit = false;
                        Object.keys(errorResults).forEach(key => {
                            const idx = parseInt(key.replace('q', ''));
                            const errInfo = errorResults[key];
                            if (errInfo.error === 'OPERATION_TIME_LIMIT') {
                                retryQueue.push(chunk[idx]);
                                timeLimitHit = true;
                            } else {
                                errorCount++;
                                totalErrors++;
                                addLog(`Lead ${chunk[idx]?.leadId} atama hatasƒ±: ${JSON.stringify(errInfo)}`, 'error');
                            }
                        });

                        // Time limit yediyse 60s bekle
                        if (timeLimitHit) {
                            addLog(`  ‚è≥ OPERATION_TIME_LIMIT: ${retryQueue.length} lead kuyruƒüa alƒ±ndƒ±, 60s bekleniyor...`, 'warning');
                            await new Promise(r => setTimeout(r, 60000));
                        }

                        batchDone = true;
                    } catch (err) {
                        if (err.message && err.message.includes('OPERATION_TIME_LIMIT')) {
                            // T√ºm batch time limit yedi
                            retryQueue.push(...chunk);
                            addLog(`  ‚è≥ Batch OPERATION_TIME_LIMIT: ${chunk.length} lead kuyruƒüa alƒ±ndƒ±, 60s bekleniyor...`, 'warning');
                            await new Promise(r => setTimeout(r, 60000));
                            batchDone = true;
                        } else if (err.message && err.message.includes('Failed to fetch')) {
                            // Aƒü hatasƒ± / API bloklandƒ± ‚Äî retry kuyruƒüuna al, 60s bekle
                            retryQueue.push(...chunk);
                            addLog(`  ‚è≥ API bloklandƒ± (Failed to fetch): ${chunk.length} lead kuyruƒüa alƒ±ndƒ±, 60s bekleniyor...`, 'warning');
                            await new Promise(r => setTimeout(r, 60000));
                            batchDone = true;
                        } else {
                            retryCount++;
                            if (retryCount < 3) {
                                addLog(`Batch hatasƒ±, ${retryCount * 10}s bekleniyor: ${err.message}`, 'warning');
                                await new Promise(r => setTimeout(r, retryCount * 10000));
                            } else {
                                // 3 deneme ba≈üarƒ±sƒ±z ‚Äî retry kuyruƒüuna al (kaybetme)
                                retryQueue.push(...chunk);
                                addLog(`Batch hatasƒ± (3 deneme): ${chunk.length} lead kuyruƒüa alƒ±ndƒ±.`, 'warning');
                                batchDone = true;
                            }
                        }
                    }
                }

                const processed = Math.min(i + BATCH_SIZE, assignments.length);
                if (processed % 100 === 0 || processed === assignments.length) {
                    addLog(`Atama: ${assignedCount}/${assignments.length} ba≈üarƒ±lƒ±${retryQueue.length > 0 ? ', ' + retryQueue.length + ' beklemede' : ''}${errorCount > 0 ? ', ' + errorCount + ' hata' : ''}`);
                }
                updateProgress(80 + Math.round((processed / assignments.length) * 18), `${processed}/${assignments.length} lead atandƒ±...`);

                // Rate limit korumasƒ±
                if (i + BATCH_SIZE < assignments.length) {
                    await new Promise(r => setTimeout(r, 400));
                }
            }

            // Retry kuyruƒüundaki leadleri tekrar dene (max 5 tur)
            let retryRound = 0;
            while (retryQueue.length > 0 && retryRound < 5 && !shouldStop) {
                retryRound++;
                addLog(`üîÑ Retry tur ${retryRound}: ${retryQueue.length} lead tekrar deneniyor...`, 'info');
                const currentRetry = [...retryQueue];
                retryQueue = [];

                for (let i = 0; i < currentRetry.length; i += BATCH_SIZE) {
                    if (shouldStop) break;
                    const chunk = currentRetry.slice(i, i + BATCH_SIZE);
                    const commands = chunk.map(a => ({
                        method: 'crm.lead.update',
                        params: { ID: a.leadId, fields: { ASSIGNED_BY_ID: a.personnelId } }
                    }));

                    try {
                        const result = await B24.restBatch(commands);
                        const batchResult = result.result || {};
                        const successResults = batchResult.result || {};
                        const errorResults = batchResult.result_error || {};

                        assignedCount += Object.keys(successResults).length;

                        let timeLimitHit = false;
                        Object.keys(errorResults).forEach(key => {
                            const idx = parseInt(key.replace('q', ''));
                            const errInfo = errorResults[key];
                            if (errInfo.error === 'OPERATION_TIME_LIMIT') {
                                retryQueue.push(chunk[idx]);
                                timeLimitHit = true;
                            } else {
                                errorCount++;
                                totalErrors++;
                            }
                        });

                        if (timeLimitHit) {
                            addLog(`  ‚è≥ Time limit devam ediyor, 60s bekleniyor...`, 'warning');
                            await new Promise(r => setTimeout(r, 60000));
                        }
                    } catch (err) {
                        if (err.message && (err.message.includes('OPERATION_TIME_LIMIT') || err.message.includes('Failed to fetch'))) {
                            retryQueue.push(...chunk);
                            addLog(`  ‚è≥ Retry hatasƒ±, 60s bekleniyor: ${err.message}`, 'warning');
                            await new Promise(r => setTimeout(r, 60000));
                        } else {
                            errorCount += chunk.length;
                            totalErrors += chunk.length;
                            addLog(`Retry batch hatasƒ±: ${err.message}`, 'error');
                        }
                    }

                    await new Promise(r => setTimeout(r, 400));
                }

                addLog(`Retry tur ${retryRound} sonucu: ${assignedCount} ba≈üarƒ±lƒ±, ${retryQueue.length} kalan`, 'info');
            }

            if (retryQueue.length > 0) {
                errorCount += retryQueue.length;
                totalErrors += retryQueue.length;
                addLog(`${retryQueue.length} lead 5 retry sonrasƒ± atanamadƒ±.`, 'error');
            }

            addLog(`Atama tamamlandƒ±: ${assignedCount} ba≈üarƒ±lƒ±, ${errorCount} hata.`, assignedCount > 0 ? 'success' : 'error');
        } else if (isDryRun) {
            addLog('üß™ Dry Run modu: Ger√ßek atama yapƒ±lmadƒ±.', 'info');

            // Show what would happen
            Object.keys(details).forEach(ruleName => {
                const ruleDetail = details[ruleName];
                Object.keys(ruleDetail).forEach(personName => {
                    addLog(`  ${ruleName} ‚Üí ${personName}: ${ruleDetail[personName]} lead`, 'info');
                });
            });

        }

        addLog('‚úÖ Daƒüƒ±tƒ±m tamamlandƒ±!', 'success');
        updateProgress(100, 'Tamamlandƒ±');

    } catch(err) {
        addLog(`Kritik hata: ${err}`, 'error');
    }

    finishDistribution(startTime, totalDistributed, totalErrors, totalUnmatched, isDryRun, details);
}

function finishDistribution(startTime, distributed, errors, unmatched, isDryRun, details) {
    const duration = ((Date.now() - startTime) / 1000).toFixed(1);
    isDistributing = false;
    document.getElementById('startDistBtn').disabled = false;

    // Update stats
    document.getElementById('statLastDistributed').textContent = distributed + ' lead';
    document.getElementById('statLastDate').textContent = new Date().toLocaleString('tr-TR') + ' ¬∑ ' + duration + 's' + (errors > 0 ? ' ¬∑ ' + errors + ' hata' : '');

    // Save log
    APP_DATA.logs.unshift({
        date: new Date().toISOString(),
        mode: isDryRun ? 'Dry Run' : 'Canlƒ±',
        totalLeads: distributed + unmatched,
        distributed: distributed,
        unmatched: unmatched,
        errors: errors,
        duration: duration + 's',
        details: details
    });

    // Keep max 50 logs
    if (APP_DATA.logs.length > 50) APP_DATA.logs = APP_DATA.logs.slice(0, 50);

    B24.saveAppData();
    renderPersonnel();
    renderLogs();
    updateBadges();
}

function stopDistribution() {
    shouldStop = true;
    addLog('Durdurma isteƒüi g√∂nderildi...', 'error');
}

// ============================================================
// RULE MATCHING ENGINE
// ============================================================
function extractPhone(lead) {
    // 1) Enrichment'tan gelen cache
    if (lead._phone) return lead._phone;
    // 2) Bitrix24 multi-field array: [{VALUE: "+359...", VALUE_TYPE: "WORK"}]
    if (lead.PHONE && Array.isArray(lead.PHONE) && lead.PHONE.length > 0) {
        return lead.PHONE[0].VALUE || '';
    }
    // 3) D√ºz string
    if (typeof lead.PHONE === 'string' && lead.PHONE.length > 0) return lead.PHONE;
    // 4) Bitrix24 bazen PHONE yerine PHONE.0.VALUE gibi flatten edebilir
    if (lead['PHONE[0][VALUE]']) return lead['PHONE[0][VALUE]'];
    return '';
}

// crm.lead.list multi-field (PHONE) d√∂nd√ºrmeyebilir ‚Äî batch crm.lead.get ile √ßek
let _enrichDebugDone = false;
const _phoneCache = new Map(); // Global phone cache: leadId ‚Üí phone string

async function enrichLeadsWithPhone(leads) {
    if (!B24.ready || leads.length === 0) return;

    // Cache'den zaten bilinen lead'leri ayƒ±r
    const needsEnrich = [];
    for (const lead of leads) {
        if (_phoneCache.has(String(lead.ID))) {
            const cached = _phoneCache.get(String(lead.ID));
            lead._phone = cached;
            if (!lead.PHONE && cached) lead.PHONE = [{ VALUE: cached }];
        } else {
            needsEnrich.push(lead);
        }
    }
    if (needsEnrich.length === 0) return;

    const BATCH = 50;
    for (let i = 0; i < needsEnrich.length; i += BATCH) {
        const chunk = needsEnrich.slice(i, i + BATCH);
        const commands = chunk.map(lead => ({
            method: 'crm.lead.get',
            params: { ID: lead.ID }
        }));
        try {
            const result = await B24.restBatch(commands);
            const batchResult = result.result?.result || {};

            if (!_enrichDebugDone) {
                _enrichDebugDone = true;
                const firstKey = Object.keys(batchResult)[0];
                const firstLead = firstKey ? batchResult[firstKey] : null;
                if (firstLead) {
                    const phoneField = firstLead.PHONE;
                    const keys = Object.keys(firstLead).filter(k => k.toLowerCase().includes('phone') || k.toLowerCase().includes('tel'));
                    addLog('  DEBUG enrich ‚Üí PHONE=' + JSON.stringify(phoneField)?.substring(0, 120), 'info');
                }
            }

            Object.keys(batchResult).forEach(key => {
                const idx = parseInt(key.replace('q', ''));
                const leadData = batchResult[key];
                if (leadData && chunk[idx]) {
                    const phone = leadData.PHONE;
                    let phoneStr = '';
                    if (phone && Array.isArray(phone) && phone.length > 0) {
                        chunk[idx].PHONE = phone;
                        phoneStr = phone[0].VALUE || '';
                        chunk[idx]._phone = phoneStr;
                    } else if (typeof phone === 'string' && phone.length > 0) {
                        phoneStr = phone;
                        chunk[idx]._phone = phoneStr;
                    }
                    _phoneCache.set(String(chunk[idx].ID), phoneStr);
                }
            });
        } catch (err) {
            addLog('  enrichPhone hatasƒ±: ' + err.message, 'error');
        }
        if (i + BATCH < needsEnrich.length) {
            await new Promise(r => setTimeout(r, 100));
        }
    }
}

function matchRule(rule, lead, phone, language, service) {
    let conditions = 0;
    let matches = 0;

    // Language check (metin kar≈üƒ±la≈ütƒ±rma ‚Äî "German", "English" vb.)
    if (rule.language) {
        conditions++;
        const langs = rule.language.split(',').map(l => l.trim().toLowerCase());
        if (langs.includes(language.toLowerCase())) matches++;
    }

    // Phone prefix check (starts with ‚Äî "+49", "+90" vb.)
    if (rule.phonePrefix) {
        conditions++;
        const prefixes = rule.phonePrefix.split(',').map(p => p.trim());
        if (prefixes.some(prefix => phone.startsWith(prefix))) matches++;
    }

    // Service check (Lead Requirement ‚Äî metin kar≈üƒ±la≈ütƒ±rma)
    if (rule.service) {
        conditions++;
        const services = rule.service.split(',').map(s => s.trim().toLowerCase());
        if (services.some(s => service.toLowerCase().includes(s))) matches++;
    }

    // Eƒüer hi√ß ko≈üul yoksa DEFAULT kural (her ≈üeyle e≈üle≈üir)
    if (conditions === 0) return true;

    // T√ºm ko≈üullar e≈üle≈ümeli (AND mantƒ±ƒüƒ±)
    return matches === conditions;
}

function getRulePersonnel(rule, allActivePersonnel) {
    if (rule.personnel === 'ALL') return allActivePersonnel;

    const ids = rule.personnel.split(',').map(id => parseInt(id.trim()));
    return allActivePersonnel.filter(p => ids.includes(p.bitrixId));
}

// ============================================================
// LOGS
// ============================================================
function renderLogs() {
    const tbody = document.getElementById('logsTableBody');
    const empty = document.getElementById('logsEmpty');
    const container = document.getElementById('logsTableContainer');
    document.getElementById('logsBadge').textContent = APP_DATA.logs.length;

    if (APP_DATA.logs.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
    }

    container.style.display = 'block';
    empty.style.display = 'none';

    tbody.innerHTML = APP_DATA.logs.map((log, i) => {
        const date = new Date(log.date).toLocaleString('tr-TR');
        const modeTag = log.mode === 'Dry Run' ? '<span class="tag tag-phone">Dry Run</span>' : '<span class="tag tag-service">Canlƒ±</span>';
        return `<tr>
            <td style="font-size:12px;">${date}</td>
            <td>${modeTag}</td>
            <td>${log.totalLeads || 0}</td>
            <td><strong style="color:var(--green-text)">${log.distributed}</strong></td>
            <td>${log.unmatched || 0}</td>
            <td>${log.errors > 0 ? `<span style="color:var(--red)">${log.errors}</span>` : '0'}</td>
            <td>${log.duration}</td>
            <td><button class="btn btn-icon btn-ghost" onclick="showLogDetail(${i})" title="Detay">üìã</button></td>
        </tr>`;
    }).join('');
}

function showLogDetail(index) {
    const log = APP_DATA.logs[index];
    let html = `<div style="margin-bottom:16px;">
        <p><strong>Tarih:</strong> ${escapeHtml(new Date(log.date).toLocaleString('tr-TR'))}</p>
        <p><strong>Mod:</strong> ${escapeHtml(log.mode)}</p>
        <p><strong>Toplam:</strong> ${log.distributed} daƒüƒ±tƒ±lan, ${log.unmatched || 0} e≈üle≈ümeyen, ${log.errors} hata</p>
        <p><strong>S√ºre:</strong> ${escapeHtml(log.duration)}</p>
    </div>`;

    if (log.details && Object.keys(log.details).length > 0) {
        html += '<h4 style="margin-bottom:8px;">Kural Bazlƒ± Daƒüƒ±lƒ±m</h4>';
        html += '<div class="table-wrap"><table><thead><tr><th>Kural</th><th>Personel</th><th>Lead</th></tr></thead><tbody>';
        Object.keys(log.details).forEach(ruleName => {
            Object.keys(log.details[ruleName]).forEach(personName => {
                html += `<tr><td>${escapeHtml(ruleName)}</td><td>${escapeHtml(personName)}</td><td><strong>${log.details[ruleName][personName]}</strong></td></tr>`;
            });
        });
        html += '</tbody></table></div>';
    }

    document.getElementById('logDetailContent').innerHTML = html;
    document.getElementById('logDetailModal').classList.add('active');
}

function closeLogDetailModal() {
    document.getElementById('logDetailModal').classList.remove('active');
}

function clearLogs() {
    if (!confirm('T√ºm loglarƒ± silmek istediƒüinize emin misiniz?')) return;
    APP_DATA.logs = [];
    B24.saveAppData();
    renderLogs();
}

// ============================================================
// UTILITY
// ============================================================
function updateBadges() {
    const activeRules = APP_DATA.rules.filter(r => r.active !== false);
    const activePersonnel = APP_DATA.personnel.filter(p => p.active !== false);

    document.getElementById('rulesBadge').textContent = APP_DATA.rules.length;
    document.getElementById('personnelBadge').textContent = APP_DATA.personnel.length;
    document.getElementById('logsBadge').textContent = APP_DATA.logs.length;
    document.getElementById('statActiveRules').textContent = activeRules.length;

    // Kurallarda kullanƒ±lan benzersiz personel ID'leri
    const usedPersonnelIds = new Set();
    activeRules.forEach(rule => {
        if (rule.personnel === 'ALL') {
            activePersonnel.forEach(p => usedPersonnelIds.add(p.bitrixId));
        } else if (rule.personnel) {
            rule.personnel.split(',').forEach(id => usedPersonnelIds.add(parseInt(id.trim())));
        }
    });

    // Sadece kurallarda kullanƒ±lan aktif personeller
    const rulePersonnel = activePersonnel.filter(p => usedPersonnelIds.has(p.bitrixId));
    document.getElementById('statActivePersonnel').textContent = rulePersonnel.length + ' / ' + activePersonnel.length;

    const totalNeed = rulePersonnel
        .reduce((sum, p) => sum + Math.max(0, (p.quota || 200) - (p.currentNew || 0)), 0);
    document.getElementById('statTotalNeed').textContent = totalNeed;
}

// Personel lead sayƒ±larƒ±nƒ± manuel g√ºncelle (Canlƒ± Veri butonu)
async function refreshPersonnelCounts() {
    if (!B24.ready) { alert('Demo modda g√ºncelleme yapƒ±lamaz.'); return; }
    const btns = [document.getElementById('refreshCountsBtn'), document.getElementById('personnelRefreshBtn')].filter(Boolean);
    btns.forEach(b => { b.disabled = true; b.textContent = '‚è≥ G√ºncelleniyor...'; });

    try {
        await loadPersonnelCounts();
        await loadPoolStats();
        btns.forEach(b => { b.textContent = '‚úì G√ºncellendi'; });
        setTimeout(() => { btns.forEach(b => { b.textContent = 'üîÑ Canlƒ± Veri G√ºncelle'; b.disabled = false; }); }, 2000);
    } catch(err) {
        btns.forEach(b => { b.textContent = '‚ùå Hata'; });
        setTimeout(() => { btns.forEach(b => { b.textContent = 'üîÑ Canlƒ± Veri G√ºncelle'; b.disabled = false; }); }, 2000);
    }
}

// Havuzdaki lead sayƒ±sƒ±nƒ± Bitrix24'ten √ßek
async function loadPoolStats() {
    if (!B24.ready) {
        document.getElementById('statPoolLeads').textContent = 'N/A';
        return;
    }
    try {
        const result = await Promise.race([
            B24.call('crm.lead.list', {
                filter: { ASSIGNED_BY_ID: APP_DATA.settings.poolUserId, STATUS_ID: LEAD_STATUS_FILTER },
                select: ['ID'],
                start: -1
            }),
            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 10000))
        ]);
        const total = result.total ? result.total() : 0;
        document.getElementById('statPoolLeads').textContent = total;
    } catch(err) {
        console.error('Pool stats hatasƒ±:', err);
        document.getElementById('statPoolLeads').textContent = '?';
    }
}

// Personel lead sayƒ±larƒ±nƒ± Bitrix24'ten √ßek (BATCH optimized)
async function loadPersonnelCounts() {
    if (!B24.ready) return;
    const personnel = APP_DATA.personnel || [];
    if (personnel.length === 0) return;

    debugLog('Personel lead sayƒ±larƒ± sorgulanƒ±yor...');
    let updated = 0;
    const BATCH_SZ = 50;
    try {
        for (let bi = 0; bi < personnel.length; bi += BATCH_SZ) {
            const chunk = personnel.slice(bi, bi + BATCH_SZ);
            const commands = chunk.map(p => ({
                method: 'crm.lead.list',
                params: { filter: { ASSIGNED_BY_ID: p.bitrixId, STATUS_ID: LEAD_STATUS_FILTER }, select: ['ID'], start: 0 }
            }));
            const batchResult = await Promise.race([
                B24.restBatch(commands),
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 15000))
            ]);
            const bRes = batchResult.result || batchResult;
            const resTotal = bRes.result_total || {};
            const resData = bRes.result || {};
            chunk.forEach((person, idx) => {
                const key = `q${idx}`;
                let count = resTotal[key];
                if (count === undefined || count === null) {
                    const d = resData[key];
                    count = Array.isArray(d) ? d.length : 0;
                }
                person.currentNew = count;
                updated++;
            });
        }
    } catch(err) {
        console.warn('Batch personel sayƒ±sƒ± hatasƒ±, fallback:', err);
    }
    debugLog(updated + '/' + personnel.length + ' personel lead sayƒ±sƒ± g√ºncellendi');
    await B24.saveAppData();
    renderPersonnel();
    updateBadges();
}

// ============================================================
// LEAD PIVOT TABLE ‚Äî Personel √ó A≈üama kƒ±rƒ±lƒ±mlƒ± lead sayƒ±larƒ±
// ============================================================
let _pivotStatusCache = null; // { statusId: statusName } cache

async function loadLeadPivot() {
    const container = document.getElementById('pivotContainer');
    const section = document.getElementById('pivotSection');
    const personnel = APP_DATA.personnel || [];

    if (personnel.length === 0) {
        section.style.display = 'none';
        return;
    }
    section.style.display = 'block';
    container.innerHTML = '<div class="pivot-loading"><span class="spinner-inline"></span> Lead a≈üamalarƒ± y√ºkleniyor...</div>';

    try {
        // 1) Lead stat√ºlerini Bitrix24'ten √ßek (cache'li)
        if (!_pivotStatusCache) {
            const statusResult = await B24.restCall('crm.status.list', {
                filter: { ENTITY_ID: 'STATUS' },
                order: { SORT: 'ASC' }
            });
            const statuses = statusResult.result || [];
            _pivotStatusCache = {};
            statuses.forEach(s => {
                _pivotStatusCache[s.STATUS_ID] = s.NAME;
            });
            // Fallback: eƒüer bo≈ü geldiyse varsayƒ±lan
            if (Object.keys(_pivotStatusCache).length === 0) {
                _pivotStatusCache = { 'NEW': 'New', 'IN_PROCESS': 'In Process', 'PROCESSED': 'Processed', 'JUNK': 'Junk' };
            }
        }

        // Ba≈üarƒ±sƒ±z + Converted a≈üamalarƒ±nƒ± filtrele
        const EXCLUDED_STATUSES = [
            'not interested', 'not eligible', 'need visa', 'wrong number',
            'operated with us', 'operated with another clinic', 'blocked me',
            'financial problem', 'expensive', 'transfer to medical consultant',
            'transfer to medical concultant', 'converted'
        ];
        // "Cevapsƒ±z" olarak birle≈ütirilecek a≈üamalar
        const CEVAPMAZ_STATUSES = ['no answer', 'whatsapp message sent', 'no social media'];

        const allStatusIds = Object.keys(_pivotStatusCache).filter(sid => {
            const name = (_pivotStatusCache[sid] || '').toLowerCase().trim();
            return !EXCLUDED_STATUSES.some(ex => name.includes(ex) || ex.includes(name));
        });

        // Cevapsƒ±z birle≈ütirme: hangi status ID'ler birle≈üecek
        const cevapsizIds = allStatusIds.filter(sid => {
            const name = (_pivotStatusCache[sid] || '').toLowerCase().trim();
            return CEVAPMAZ_STATUSES.some(ex => name.includes(ex));
        });
        const nonCevapsizIds = allStatusIds.filter(sid => !cevapsizIds.includes(sid));

        // G√∂r√ºnt√º s√ºtunlarƒ±: birle≈ütirilmi≈ü "Cevapsƒ±z" + geri kalanlar
        // displayColumns: { key, label, sourceIds[] }
        const displayColumns = [];

        // Sƒ±ralama tanƒ±mƒ± (k√º√ß√ºk harf e≈üle≈üme)
        const SORT_ORDER = [
            'new', 're engage', 'positive call', 'will send photo',
            'following', 'thinking', 'will buy'
        ];

        // √ñnce sƒ±ralƒ± olanlarƒ± ekle
        SORT_ORDER.forEach(sortName => {
            if (sortName === 'new') {
                // New'den sonra Cevapsƒ±z gelecek ‚Äî √∂nce New'i bul
                const found = nonCevapsizIds.find(sid => (_pivotStatusCache[sid] || '').toLowerCase().trim() === 'new');
                if (found) displayColumns.push({ key: found, label: _pivotStatusCache[found], sourceIds: [found] });
                // New'den hemen sonra Cevapsƒ±z
                if (cevapsizIds.length > 0) {
                    displayColumns.push({ key: '_cevapsiz', label: 'Cevapsiz', sourceIds: cevapsizIds });
                }
            } else {
                const found = nonCevapsizIds.find(sid => (_pivotStatusCache[sid] || '').toLowerCase().trim().includes(sortName));
                if (found) displayColumns.push({ key: found, label: _pivotStatusCache[found], sourceIds: [found] });
            }
        });

        // Sƒ±ralamada olmayan kalan stat√ºleri sona ekle
        const usedIds = new Set(displayColumns.flatMap(d => d.sourceIds));
        nonCevapsizIds.forEach(sid => {
            if (!usedIds.has(sid)) {
                displayColumns.push({ key: sid, label: _pivotStatusCache[sid], sourceIds: [sid] });
            }
        });

        // API'ye sorulacak t√ºm status ID'leri (birle≈ütirilmi≈üler dahil)
        const queryStatusIds = allStatusIds;

        // Havuz hesabƒ±nƒ± ve pasif personeli √ßƒ±kar (sorgu azaltma)
        const poolUserId = APP_DATA.settings?.poolUserId || 0;
        const activePersonnel = personnel.filter(p => p.active !== false && p.bitrixId !== poolUserId);

        container.innerHTML = '<div class="pivot-loading"><span class="spinner-inline"></span> Personel verileri sorgulanƒ±yor (0/' + activePersonnel.length + ')...</div>';

        // 2) Her personel √ó her stat√º i√ßin batch sorgula
        const pivotData = {}; // { bitrixId: { statusId: count } }
        const queries = [];

        for (const person of activePersonnel) {
            pivotData[person.bitrixId] = {};
            for (const sid of queryStatusIds) {
                queries.push({
                    personId: person.bitrixId,
                    statusId: sid,
                    method: 'crm.lead.list',
                    params: {
                        filter: { ASSIGNED_BY_ID: person.bitrixId, STATUS_ID: sid },
                        select: ['ID'],
                        start: 0
                    }
                });
            }
        }

        // Batch √ßaƒürƒ±larƒ±nƒ± 50'lik gruplara b√∂l
        const BATCH_SIZE = 50;
        let completed = 0;
        for (let i = 0; i < queries.length; i += BATCH_SIZE) {
            const chunk = queries.slice(i, i + BATCH_SIZE);
            const commands = chunk.map(q => ({ method: q.method, params: q.params }));

            const batchResult = await B24.restBatch(commands);
            // pivot batch processed

            const batchRes = batchResult.result || batchResult;
            const resultData = batchRes.result || {};
            const resultTotal = batchRes.result_total || {};

            chunk.forEach((q, idx) => {
                const key = `q${idx}`;
                // √ñncelik: result_total > data array length
                let total = resultTotal[key];
                if (total === undefined || total === null) {
                    // Fallback: data array'den oku
                    const data = resultData[key];
                    total = Array.isArray(data) ? data.length : 0;
                }
                pivotData[q.personId][q.statusId] = total;
            });

            completed += chunk.length;
            const pctDone = Math.round((completed / queries.length) * 100);
            const personnelDone = Math.floor(completed / queryStatusIds.length);
            container.innerHTML = '<div class="pivot-loading"><span class="spinner-inline"></span> Personel verileri sorgulanƒ±yor (' + personnelDone + '/' + activePersonnel.length + ') %' + pctDone + '...</div>';
        }

        // 3) Tabloyu render et (toplam 0 olanlarƒ± g√∂sterme)
        renderPivotTable(activePersonnel, displayColumns, pivotData);

    } catch (err) {
        console.error('Pivot tablo hatasƒ±:', err);
        container.innerHTML = '<div class="pivot-loading" style="color:var(--red);">‚ùå Hata: ' + escapeHtml(err.message) + '</div>';
    }
}

function renderPivotTable(personnel, displayColumns, pivotData) {
    const container = document.getElementById('pivotContainer');

    // Header
    let html = '<div class="pivot-wrap"><table><thead><tr><th>Personel</th>';
    displayColumns.forEach(col => {
        html += '<th>' + escapeHtml(col.label) + '</th>';
    });
    html += '<th style="background:var(--bg-hover);color:var(--text-primary);">TOPLAM</th></tr></thead><tbody>';

    // S√ºtun toplamlarƒ±
    const colTotals = {};
    displayColumns.forEach(col => { colTotals[col.key] = 0; });
    let grandTotal = 0;

    // Toplam lead'i 0 olanlarƒ± √ßƒ±kar, kalanlarƒ± sƒ±rala (en √ßok ‚Üí en az)
    const sortedPersonnel = [...personnel]
        .map(p => {
            const total = displayColumns.reduce((sum, col) => sum + col.sourceIds.reduce((s, sid) => s + (pivotData[p.bitrixId]?.[sid] || 0), 0), 0);
            return { person: p, total };
        })
        .filter(x => x.total > 0)
        .sort((a, b) => b.total - a.total)
        .map(x => x.person);

    sortedPersonnel.forEach(person => {
        const data = pivotData[person.bitrixId] || {};
        let rowTotal = 0;
        const isActive = person.active !== false;
        const nameStyle = isActive ? '' : ' style="opacity:0.5;"';
        const badge = isActive ? '' : ' <span style="font-size:10px;color:var(--red);font-weight:400;">(pasif)</span>';

        html += '<tr><td' + nameStyle + '>' + escapeHtml(person.name) + badge + '</td>';
        displayColumns.forEach(col => {
            // Birle≈ütirilmi≈ü s√ºtunlar: sourceIds'lerdeki deƒüerleri topla
            const count = col.sourceIds.reduce((sum, sid) => sum + (data[sid] || 0), 0);
            rowTotal += count;
            colTotals[col.key] += count;
            let cellClass = '';
            if (count === 0) cellClass = ' class="pivot-cell-zero"';
            else if (count >= 500) cellClass = ' class="pivot-cell-critical"';
            else if (count >= 200) cellClass = ' class="pivot-cell-high"';
            html += '<td' + cellClass + '>' + count + '</td>';
        });
        grandTotal += rowTotal;
        html += '<td style="font-weight:700;color:var(--text-primary);">' + rowTotal + '</td>';
        html += '</tr>';
    });

    // Toplam satƒ±rƒ±
    html += '<tr class="pivot-total"><td>TOPLAM</td>';
    displayColumns.forEach(col => {
        html += '<td>' + colTotals[col.key] + '</td>';
    });
    html += '<td>' + grandTotal + '</td></tr>';

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// ============================================================
// ENUM LOADER ‚Äî Dropdown deƒüerlerini Bitrix24'ten √ßek
// ============================================================
async function loadEnumValues() {
    if (!B24.ready) {
        console.log('Demo mod ‚Äî enum deƒüerleri y√ºklenemiyor');
        return;
    }

    try {
        // Y√∂ntem 1: crm.lead.fields ile dene
        console.log('Enum y√ºkleme: crm.lead.fields deneniyor...');
        const result = await B24.call('crm.lead.fields', {});
        const fields = result.data ? result.data() : {};

        const langField = fields[FIELD_MAP.language];
        if (langField && langField.items && langField.items.length > 0) {
            langField.items.forEach(item => {
                ENUM_LABELS.language[String(item.ID)] = item.VALUE;
            });
            console.log('Language enum y√ºklendi (crm.lead.fields):', Object.keys(ENUM_LABELS.language).length, 'deƒüer');
        } else {
            console.warn('crm.lead.fields ile language items bulunamadƒ±, field:', langField);
        }

        const svcField = fields[FIELD_MAP.service];
        if (svcField && svcField.items && svcField.items.length > 0) {
            svcField.items.forEach(item => {
                ENUM_LABELS.service[String(item.ID)] = item.VALUE;
            });
            console.log('Service enum y√ºklendi (crm.lead.fields):', Object.keys(ENUM_LABELS.service).length, 'deƒüer');
        } else {
            console.warn('crm.lead.fields ile service items bulunamadƒ±, field:', svcField);
        }

        // Y√∂ntem 1 ba≈üarƒ±sƒ±zsa ‚Üí Y√∂ntem 2: crm.lead.userfield.list ile dene
        if (Object.keys(ENUM_LABELS.language).length === 0 || Object.keys(ENUM_LABELS.service).length === 0) {
            console.log('Enum y√ºkleme: crm.lead.userfield.list fallback deneniyor...');
            await loadEnumFromUserFields();
        }

    } catch(err) {
        console.error('crm.lead.fields hatasƒ±:', err);
        // Fallback: userfield.list ile dene
        try {
            console.log('Fallback: crm.lead.userfield.list deneniyor...');
            await loadEnumFromUserFields();
        } catch(err2) {
            console.error('crm.lead.userfield.list de ba≈üarƒ±sƒ±z:', err2);
        }
    }

    console.log('Enum sonu√ß ‚Äî Language:', Object.keys(ENUM_LABELS.language).length, 'Service:', Object.keys(ENUM_LABELS.service).length);
}

async function loadEnumFromUserFields() {
    let allFields = [];
    let start = 0;

    while (true) {
        const result = await B24.call('crm.lead.userfield.list', { start: start });
        const data = result.data ? result.data() : [];
        if (!data || data.length === 0) break;
        allFields = allFields.concat(data);
        if (result.more && result.more()) {
            start = result.next ? result.next() : start + 50;
        } else {
            break;
        }
    }

    console.log('Userfield toplam:', allFields.length, 'alan bulundu');

    allFields.forEach(uf => {
        const fieldName = uf.FIELD_NAME;
        const enumItems = uf.LIST || [];

        if (fieldName === FIELD_MAP.language && enumItems.length > 0 && Object.keys(ENUM_LABELS.language).length === 0) {
            enumItems.forEach(item => {
                ENUM_LABELS.language[String(item.ID)] = item.VALUE;
            });
            console.log('Language enum y√ºklendi (userfield.list):', Object.keys(ENUM_LABELS.language).length, 'deƒüer');
        }

        if (fieldName === FIELD_MAP.service && enumItems.length > 0 && Object.keys(ENUM_LABELS.service).length === 0) {
            enumItems.forEach(item => {
                ENUM_LABELS.service[String(item.ID)] = item.VALUE;
            });
            console.log('Service enum y√ºklendi (userfield.list):', Object.keys(ENUM_LABELS.service).length, 'deƒüer');
        }
    });
}

// Enum ID'yi label'a √ßevir
function enumToLabel(enumType, id) {
    if (!id) return '';
    const label = ENUM_LABELS[enumType] && ENUM_LABELS[enumType][String(id)];
    return label || String(id);
}

// ============================================================
// DEBUG ‚Äî sayfada g√∂r√ºn√ºr durum bilgisi
// ============================================================
function debugLog(msg, isError) {
    // debug status update
    const el = document.getElementById('connectionStatus');
    if (el) el.textContent = msg;
    if (isError) {
        const dot = document.getElementById('connectionDot');
        if (dot) dot.style.background = 'var(--red)';
    }
}

// ============================================================
// INIT
// ============================================================
const ALLOWED_USERS = [1]; // Yetkili Bitrix24 kullanƒ±cƒ± ID'leri

async function init() {
    try {
        debugLog('BX24 init ba≈ülatƒ±lƒ±yor...');
        const ready = await B24.init();
        debugLog(ready ? `Baƒülƒ±: ${B24.domain}` : 'Demo Mod ‚Äî BX24 SDK bulunamadƒ±');

        // Kullanƒ±cƒ± yetki kontrol√º
        if (B24.ready) {
            try {
                const userResult = await B24.call('user.current', {});
                const currentUser = userResult.data();
                const userId = parseInt(currentUser.ID);
                debugLog(`Kullanƒ±cƒ±: ID ${userId}`);
                if (!ALLOWED_USERS.includes(userId)) {
                    document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Inter,sans-serif;"><h2 style="color:#666;">Bu uygulamaya eri≈üim yetkiniz bulunmamaktadƒ±r.</h2></div>';
                    return;
                }
                debugLog(`Kullanƒ±cƒ± doƒürulandƒ±: ID ${userId}`);
            } catch(e) { debugLog('Kullanƒ±cƒ± kontrol√º atlandƒ±: ' + e); }
        }

        debugLog('Kayƒ±tlƒ± veriler y√ºkleniyor...');
        await B24.loadAppData();
        // T√ºm kotalarƒ± 200'e zorla
        APP_DATA.personnel.forEach(p => p.quota = 200);
        APP_DATA.rules.forEach(r => r.quota = 200);
        debugLog(`Veri y√ºklendi: ${APP_DATA.rules.length} kural, ${APP_DATA.personnel.length} personel`);

        debugLog('Enum deƒüerleri y√ºkleniyor...');
        await loadEnumValues();
        const langCount = Object.keys(ENUM_LABELS.language).length;
        const svcCount = Object.keys(ENUM_LABELS.service).length;
        debugLog(`Enum: ${langCount} dil, ${svcCount} servis y√ºklendi`);

        if (langCount === 0 && svcCount === 0 && B24.ready) {
            debugLog('UYARI: Enum y√ºklenemedi ‚Äî API yanƒ±tƒ± bo≈ü', true);
        }

        renderRules();
        renderPersonnel();
        renderLogs();
        updateBadges();

        // Havuzdaki lead sayƒ±sƒ±nƒ± √ßek
        debugLog('Havuz istatistikleri y√ºkleniyor...');
        await loadPoolStats();

        // Header meta bilgileri g√ºncelle
        const enumInfo = document.getElementById('headerEnumInfo');
        if (enumInfo) enumInfo.textContent = `${langCount} dil ¬∑ ${svcCount} servis`;

        if (B24.ready) {
            const poolCount = document.getElementById('statPoolLeads').textContent;
            debugLog(`Baƒülƒ±: ${B24.domain} ‚úì | Havuz: ${poolCount} lead | ${langCount} dil, ${svcCount} servis`);

            // Personel lead sayƒ±larƒ±nƒ± Bitrix24'ten √ßek (arka planda)
            loadPersonnelCounts();
        }
    } catch(err) {
        debugLog('INIT HATASI: ' + err.message, true);
        console.error('Init error:', err);
    }
}

init();
</script>
</body>
</html>
